<!DOCTYPE html>
<html lang='zh-HK'>
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>📷 AR 合照</title>
<link href="styles.css" rel="stylesheet"/>
<style>
    body { background: #f6f8fb; }
    .camera-wrap { position: relative; max-width: 640px; margin: 12px auto; border-radius: 16px; overflow: hidden; box-shadow: 0 12px 32px rgba(0,0,0,.12); }
    .camera { display:block; width:100%; height:auto; background:#000; }
    .overlay { position:absolute; left:0; top:0; right:0; bottom:0; overflow:visible; touch-action:none; }
    .spirit { position:absolute; left:50%; top:60%; transform: translate(-50%,-50%) scale(0.8) rotate(0deg); user-select:none; -webkit-user-drag:none; cursor: grab; filter: drop-shadow(0 8px 18px rgba(0,0,0,.18)); max-width: 70%; }
    .hint { text-align:center; color:#5b6b7a; font-weight:700; margin: 8px 0 0; }
    .toolbar { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin-top: 10px; }
    .toolbar .btn { min-width: 120px; }
    .note { text-align:center; color:#7a8699; font-size: 12px; margin-top: 8px; }
    canvas { display:none; }
  </style>
<style>
/* Tabs */
:root { --ui-bg:#0b0f17; --ui-fg:#fff; --btn:#1f2937; --btn2:#374151; }
body { background:#000; color:#fff; }
#topbar { position:sticky; top:0; background:linear-gradient(to bottom, rgba(0,0,0,.85), rgba(0,0,0,0)); padding:10px 12px; z-index:50; display:flex; gap:8px; align-items:center; }
.tab { padding:8px 12px; border-radius:12px; border:1px solid var(--btn2); background:var(--btn); color:#fff; }
.tab.active { background:#2563eb; border-color:#2563eb; }
.section { display:none; }
.section.active { display:block; }
#reticleHud { position: fixed; left:50%; top:50%; width:64px; height:64px; margin-left:-32px; margin-top:-32px; border:2px solid rgba(255,255,255,.85); border-radius:50%; box-shadow:0 0 0 2px rgba(0,0,0,.5) inset; pointer-events:none; z-index: 9; display:none;}
#countdown3d { position: fixed; inset:0; display:none; align-items:center; justify-content:center; font-size:14vw; font-weight:800; color:#fff; text-shadow:0 0 20px rgba(0,0,0,.8); z-index: 20;}
#footer3d { position: fixed; bottom: 0; left:0; right:0; display:flex; gap:10px; align-items:center; justify-content:center; padding:14px env(safe-area-inset-right) calc(14px + env(safe-area-inset-bottom)) env(safe-area-inset-left); background: linear-gradient(to top, rgba(0,0,0,0.6), rgba(0,0,0,0)); z-index: 10;}
.btn { background:#1f2937; border:1px solid #374151; padding:8px 12px; border-radius:12px; color:#fff; font-size:14px;}
.btn:hover { background:#374151; }
</style></head>
<body><div id="topbar"><button class="tab active" id="tab2d">📷 2D 合照</button><button class="tab" id="tab3d">🕶️ 3D AR</button></div><div class="section active" id="mode2d">
<div class="container">
<div class="card">
<div class="header">
<div class="title">📷 AR 合照</div>
<div class="badge">拖動、雙指縮放／旋轉精靈後拍照</div>
</div>
<div class="camera-wrap">
<video autoplay="" class="camera" id="video" muted="" playsinline=""></video>
<div class="overlay">
<img alt="spirit" class="spirit" id="spirit" src=""/>
</div>
</div>
<p class="hint" id="hint">兩指縮放／旋轉；單指拖動位置</p>
<div class="toolbar">
<button class="btn" id="btn-flip">🔄 切換前後鏡</button>
<button class="btn secondary" id="btn-reset">♻️ 重置位置</button>
<button class="btn" id="btn-shot">📸 拍照下載</button>
<a class="btn secondary" href="dex.html">📖 返回圖鑑</a>
</div>
<p class="note">相片只在本地裝置生成與保存，不會上傳伺服器。</p>
<div class="actions">
<a class="btn secondary" href="index.html">← 返回主頁</a>
</div>
</div>
</div>
<canvas id="canvas"></canvas>
<script>
    // Read query params: ?img=...&name=...
    const params = new URLSearchParams(location.search);
    const spiritImg = params.get('img') || 'images/cablecar-spirit.png';
    const spiritName = params.get('name') || 'Spirit';

    // Theme sync
    (function syncTheme(){
      const saved = localStorage.getItem('np_theme');
      if (!saved) return;
      document.body.classList.remove('theme-sky','theme-grass','theme-warm','theme-dimsum','theme-boba');
      document.body.classList.add(saved);
    })();

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const spirit = document.getElementById('spirit');
    spirit.src = spiritImg;
    spirit.alt = spiritName;

    let usingFront = false;
    let stream;

    async function startCamera(){
      if (stream) { stream.getTracks().forEach(t => t.stop()); }
      try{
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: usingFront ? 'user' : { exact: 'environment' } },
          audio: false
        });
      } catch(e){
        // Fallback if 'environment' exact not available
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: usingFront ? 'user' : 'environment' },
          audio: false
        });
      }
      video.srcObject = stream;
    }

    document.getElementById('btn-flip').addEventListener('click', ()=>{
      usingFront = !usingFront;
      startCamera();
    });

    document.getElementById('btn-reset').addEventListener('click', ()=>{
      base = { x: 0, y: 0, scale: 0.8, rot: 0 };
      apply();
    });

    // Drag / Pinch / Rotate
    let base = { x: 0, y: 0, scale: 0.8, rot: 0 };
    let last = null;

    function apply(){
      spirit.style.transform = `translate(calc(-50% + ${base.x}px), calc(-50% + ${base.y}px)) scale(${base.scale}) rotate(${base.rot}deg)`;
    }

    function distance(a,b){ return Math.hypot(a.clientX - b.clientX, a.clientY - b.clientY); }
    function angle(a,b){ return Math.atan2(b.clientY - a.clientY, b.clientX - a.clientX) * 180/Math.PI; }

    const overlay = document.querySelector('.overlay');

    overlay.addEventListener('pointerdown', (e)=>{
      e.preventDefault();
      overlay.setPointerCapture(e.pointerId);
      if (!last) last = [];
      last.push(e);
    });
    overlay.addEventListener('pointermove', (e)=>{
      if (!last) return;
      for (let i=0;i<last.length;i++){ if (last[i].pointerId === e.pointerId){ last[i] = e; break; } }
      if (last.length === 1){
        base.x += e.movementX;
        base.y += e.movementY;
      } else if (last.length >= 2){
        const [p1, p2] = last;
        if (!p1 || !p2) return;
        if (!overlay._prev){ overlay._prev = { d: distance(p1,p2), a: angle(p1,p2) }; return; }
        const d = distance(p1,p2);
        const a = angle(p1,p2);
        const scaleDelta = d / overlay._prev.d;
        base.scale = Math.min(3, Math.max(0.3, base.scale * scaleDelta));
        base.rot += (a - overlay._prev.a);
        overlay._prev = { d, a };
      }
      apply();
    });
    function endPointer(e){
      if (!last) return;
      last = last.filter(p => p.pointerId !== e.pointerId);
      if (last.length < 2) overlay._prev = null;
      if (last.length === 0) last = null;
    }
    overlay.addEventListener('pointerup', endPointer);
    overlay.addEventListener('pointercancel', endPointer);
    overlay.addEventListener('pointerleave', endPointer);

    // Shot
    document.getElementById('btn-shot').addEventListener('click', ()=>{
      const w = video.videoWidth;
      const h = video.videoHeight;
      if (!w || !h){ alert('相機尚未啟動，請稍後再試'); return; }
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, w, h);
      const img = spirit;
      const spiritDisplayWidth = Math.min(w,h) * 0.7 * base.scale;
      const ratio = img.naturalWidth / img.naturalHeight;
      const dw = spiritDisplayWidth;
      const dh = spiritDisplayWidth / ratio;
      const cx = w/2 + base.x * (w / video.clientWidth);
      const cy = h*0.6 + base.y * (h / video.clientHeight);
      ctx.save();
      ctx.translate(cx, cy);
      ctx.rotate(base.rot * Math.PI/180);
      ctx.drawImage(img, -dw/2, -dh/2, dw, dh);
      ctx.restore();
      const a = document.createElement('a');
      a.href = canvas.toDataURL('image/png');
      a.download = spiritName + '_ar_photo.png';
      a.click();
    });

    startCamera().catch(()=>{
      document.getElementById('hint').textContent = '⚠️ 無法開啟相機。請確認權限／在 HTTPS 下開啟。';
    });
  </script>
</div>
<div class="section" id="mode3d">
<div id="reticleHud"></div>
<div id="countdown3d">3</div>
<div id="footer3d">
<button class="btn" id="start3d">🕶️ 開始 3D AR</button>
<button class="btn" disabled="" id="snap3d">📸 倒數拍照</button>
<button class="btn" disabled="" id="clear3d">🗑 移除全部</button>
</div>
</div>

<script>
  const tab2d = document.getElementById('tab2d');
  const tab3d = document.getElementById('tab3d');
  const mode2d = document.getElementById('mode2d');
  const mode3d = document.getElementById('mode3d');
  function activate(tab){
    if (tab === '2d'){
      tab2d.classList.add('active'); tab3d.classList.remove('active');
      mode2d.classList.add('active'); mode3d.classList.remove('active');
    }else{
      tab3d.classList.add('active'); tab2d.classList.remove('active');
      mode3d.classList.add('active'); mode2d.classList.remove('active');
    }
  }
  tab2d.addEventListener('click', ()=> activate('2d'));
  tab3d.addEventListener('click', ()=> activate('3d'));
</script>

<script type="module">
  import * as THREE from 'https://unpkg.com/three@0.160/build/three.module.js';
  import {GLTFLoader} from 'https://unpkg.com/three@0.160/examples/jsm/loaders/GLTFLoader.js';
  import {ARButton} from 'https://unpkg.com/three@0.160/examples/jsm/webxr/ARButton.js';
  const modelURL = './cablecar_spirit_extruded_textured.glb';
  let renderer, scene, camera, reticleMesh;
  let hitTestSource = null, localSpace = null;
  let spirit = null, started = false;
  const reticleHud = document.getElementById('reticleHud');
  const cd = document.getElementById('countdown3d');
  const startBtn = document.getElementById('start3d');
  const snapBtn = document.getElementById('snap3d');
  const clearBtn = document.getElementById('clear3d');

  function ensureRenderer(){
    if (renderer) return;
    renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true, preserveDrawingBuffer:true });
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.xr.enabled = true;
    document.getElementById('mode3d').appendChild(renderer.domElement);
    window.addEventListener('resize', ()=>{
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  }
  function initScene(){
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 30);
    scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1.0));
    const dir = new THREE.DirectionalLight(0xffffff, 0.9);
    dir.position.set(1.2, 1.8, 0.8);
    scene.add(dir);
    const geo = new THREE.RingGeometry(0.08, 0.1, 32).rotateX(-Math.PI/2);
    const mat = new THREE.MeshBasicMaterial({ color: 0xffffff });
    reticleMesh = new THREE.Mesh(geo, mat);
    reticleMesh.matrixAutoUpdate = false;
    reticleMesh.visible = false;
    scene.add(reticleMesh);
  }
  async function initAR(){
    document.getElementById('mode3d').appendChild(ARButton.createButton(renderer, { requiredFeatures: ['hit-test'] }));
    const session = renderer.xr.getSession();
    const viewerSpace = await session.requestReferenceSpace('viewer');
    hitTestSource = await session.requestHitTestSource({ space: viewerSpace });
    localSpace = await session.requestReferenceSpace('local');
    session.addEventListener('end', ()=>{
      startBtn.disabled = false; snapBtn.disabled = true; clearBtn.disabled = true;
      started = false; reticleHud.style.display = 'none';
    });
  }
  function loadModel(){
    if (spirit) return;
    const loader = new GLTFLoader();
    loader.load(modelURL, (gltf)=>{
      spirit = gltf.scene;
      spirit.traverse(n => { if (n.isMesh) { n.castShadow = true; n.receiveShadow = true; } });
    });
  }
  function placeAtReticle(){
    if (!spirit || !reticleMesh.visible) return;
    const clone = spirit.clone();
    clone.position.setFromMatrixPosition(reticleMesh.matrix);
    clone.rotation.y = Math.random()*Math.PI*2;
    scene.add(clone);
    snapBtn.disabled = false; clearBtn.disabled = true ? false : false; // keep enabled once placed
    clearBtn.disabled = false;
  }
  function clearAll(){
    const toRemove = [];
    scene.traverse(o=>{ if (o!==reticleMesh && o!==camera && !o.isLight){
      if (o.type==='Scene' || o.type==='Group' || o.isMesh) toRemove.push(o);
    }});
    toRemove.forEach(o=> scene.remove(o));
    snapBtn.disabled = true; clearBtn.disabled = true;
  }
  function runCountdownThenSnap(){
    let n = 3;
    cd.textContent = n; cd.style.display = 'flex';
    const timer = setInterval(()=>{
      n -= 1;
      if (n<=0){ clearInterval(timer); cd.style.display='none'; savePNG(); }
      else cd.textContent = n;
    }, 1000);
  }
  function savePNG(){
    const a = document.createElement('a');
    a.href = renderer.domElement.toDataURL('image/png');
    a.download = 'np360-ar-photo.png';
    a.click();
  }
  function animate(){
    renderer.setAnimationLoop((t, frame)=>{
      if (frame && hitTestSource && localSpace){
        const hits = frame.getHitTestResults(hitTestSource);
        if (hits.length){
          const pose = hits[0].getPose(localSpace);
          reticleMesh.visible = true;
          reticleMesh.matrix.fromArray(pose.transform.matrix);
          reticleHud.style.display = 'block';
        }else{
          reticleMesh.visible = false;
          reticleHud.style.display = 'none';
        }
      }
      renderer.render(scene, camera);
    });
  }
  // Events
  startBtn.addEventListener('click', async ()=>{
    if (started) return;
    started = true;
    startBtn.disabled = true;
    ensureRenderer(); initScene(); loadModel(); await initAR(); animate();
  });
  document.getElementById('mode3d').addEventListener('click', ()=>{
    if (!started) return;
    placeAtReticle();
  });
  snapBtn.addEventListener('click', runCountdownThenSnap);
  clearBtn.addEventListener('click', clearAll);
</script>
</body>
</html>