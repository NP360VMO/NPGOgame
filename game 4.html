<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æŒ‘æˆ°éŠæˆ²ï½œé£²èŒ¶ä»” åŒ¹é…æŒ‘æˆ°</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    :root{
      --bg:#fff7eb; --ink:#2b2012; --card:#fffdf9; --section-bg:#fff9f0; --section-border:#eadcc8;
      --accent:#ffb547; --ok:#15a36d; --warn:#e04848; --info:#2b6eea;
      --cell:50px;         /* âœ… ç”± JS å‹•æ…‹èª¿æ•´ */
      --gap:6px;           /* âœ… ç”± JS å‹•æ…‹èª¿æ•´ï¼ˆå°è¢å¹•ç•¥ç¸®å°ï¼‰ */
      --cell-font:26px;    /* âœ… ç”± JS å‹•æ…‹èª¿æ•´ï¼Œè·Ÿéš¨ cell å°ºå¯¸ */
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Arial,"PingFang HK","Microsoft JhengHei",sans-serif;background:var(--bg);color:var(--ink)}
    .container{max-width:960px;margin:0 auto;padding:20px}
    .card{background:var(--card);border:1px solid var(--section-border);border-radius:20px;box-shadow:0 12px 28px rgba(0,0,0,.06);overflow:hidden}
    .header{display:flex;justify-content:space-between;gap:12px;align-items:center;padding:18px 20px;border-bottom:1px solid var(--section-border)}
    .title{font-size:20px;font-weight:900}
    .badge{font-weight:700;background:#fff1d8;border:1px solid #ffd9a0;color:#7a4a00;border-radius:999px;padding:6px 10px}
    .hero{display:grid;grid-template-columns:120px 1fr;gap:14px;padding:18px 20px;border-bottom:1px solid var(--section-border);
      background:linear-gradient(180deg,#fff2d8,#ffffff)}
    .img-wrap{display:flex;align-items:center;justify-content:center}
    .img-wrap img{width:96px;height:auto;filter:drop-shadow(0 10px 20px rgba(0,0,0,.12))}
    .intro p{margin:.35rem 0}
    .status-bar{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .pill{border:2px solid var(--section-border);background:#fff;border-radius:999px;padding:6px 12px;font-weight:800}
    .pill.ok{border-color:#bfe6d6;color:var(--ok)}
    .pill.warn{border-color:#ffd1d1;color:var(--warn)}
    .pill.info{border-color:#cfe0ff;color:var(--info)}
    .section{padding:18px 20px}

    .game-wrap{background:var(--section-bg);border:1px dashed var(--section-border);border-radius:16px;padding:12px}
    .stage{display:flex;flex-direction:column;align-items:center;gap:10px}
    .grid{
      display:grid;
      grid-template-columns:repeat(8, var(--cell)); /* âœ… ä¾è®Šæ•¸ */
      gap:var(--gap);                               /* âœ… ä¾è®Šæ•¸ */
      user-select:none;
      touch-action:manipulation;
      max-width:100%;
    }
    .cell{
      width:var(--cell); height:var(--cell);
      display:flex; align-items:center; justify-content:center;
      font-size:var(--cell-font);                   /* âœ… ä¾è®Šæ•¸ */
      background:#ffffff;border:1px solid #e8e2d6;border-radius:10px;
      cursor:pointer;transition:transform .08s ease, box-shadow .12s ease, border-color .12s ease;
      box-shadow:0 2px 8px rgba(0,0,0,.05)
    }
    .cell:hover{transform:translateY(-1px)}
    .cell.selected{border:2px solid #ffb547;box-shadow:0 4px 14px rgba(255,181,71,.25)}
    .cell.clearing{animation:pop .2s ease both}
    @keyframes pop{from{transform:scale(.85);opacity:.4}to{transform:scale(1.1);opacity:1}}

    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:12px}
    .btn{appearance:none;border:0;cursor:pointer;font-weight:800;padding:10px 16px;border-radius:12px;background:var(--accent);color:#fff;box-shadow:0 8px 20px rgba(0,0,0,.12)}
    .btn.secondary{background:#fff;border:1px solid var(--section-border);color:var(--ink)}
    .btn:active{transform:translateY(1px)}
    .hint{margin-top:4px;color:#7a4a00;font-weight:700}

    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:var(--accent);color:#fff;padding:10px 14px;border-radius:12px;
      font-weight:900;display:none;z-index:1000;box-shadow:0 8px 24px rgba(0,0,0,.18)}

    @media (max-width:560px){
      .hero{grid-template-columns:84px 1fr}
      .img-wrap img{width:80px}
    }
  </style>
</head>
<body class="theme-dimsum">
  <div class="container">
    <div class="card">
      <div class="header">
        <div class="title">æŒ‘æˆ°éŠæˆ² - é£²èŒ¶ä»”ï¼ˆåŒ¹é…ï¼‰</div>
        <div class="badge">ğŸ® æŒ‘æˆ°ç³» Â· å‹å‡ºå¯è§£é–</div>
      </div>

      <div class="hero">
        <div class="img-wrap"><img src="images/game-spirit3.png" alt="é£²èŒ¶ä»”"></div>
        <div class="intro">
          <p><strong>ç©æ³•ï¼š</strong>äº¤æ›ç›¸é„°æ ¼å­ï¼Œå½¢æˆ <strong>3 é€£ä»¥ä¸Š</strong> å³æ¶ˆé™¤ï¼›åœ¨é™æ™‚å…§ç´¯ç© <strong>200 åˆ†</strong> è§£é–é£²èŒ¶ä»”ã€‚</p>
          <div class="status-bar">
            <span class="pill info" id="pill-status">å°šæœªé–‹å§‹</span>
            <span class="pill ok" id="pill-score">Scoreï¼š0 / 200</span>
            <span class="pill warn" id="pill-time">Timeï¼š30s</span>
          </div>
          <div class="hint">ğŸ’¡ æç¤ºï¼šä¸€æ¬¡æ¶ˆé™¤è¶…é 3 å€‹æœƒæœ‰åŠ åˆ†ï¼</div>
        </div>
      </div>

      <div class="section">
        <div class="game-wrap">
          <div class="stage">
            <div id="grid" class="grid" aria-label="match-3 grid"></div>
            <div class="actions">
              <button class="btn" id="btn-start">â–¶ï¸ é–‹å§‹éŠæˆ²</button>
              <button class="btn secondary" id="btn-retry" style="display:none;">ğŸ” é‡æ–°é–‹å§‹</button>
            </div>
          </div>
        </div>
        <div class="actions">
          <a class="btn secondary" href="index.html">ğŸ”™ è¿”å›ä¸»é </a>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">ğŸ‰ å·²è§£é–ï¼šé£²èŒ¶ä»”ï¼</div>

  <script>
    const GRID_SIZE = 8;
    const TYPES = ['ğŸ¥Ÿ','ğŸ¥®','ğŸ¥ ','ğŸ¡','ğŸ¤'];
    const gridEl = document.getElementById('grid');
    const pillScore = document.getElementById('pill-score');
    const pillTime  = document.getElementById('pill-time');
    const pillStatus= document.getElementById('pill-status');
    const btnStart  = document.getElementById('btn-start');
    const btnRetry  = document.getElementById('btn-retry');

    let grid = [], score = 0, timeLeft = 30, running = false, selected = null;

    /* ---------------------------
       âœ… è‡ªé©æ‡‰ï¼šè¨ˆç®— cell å°ºå¯¸
       ä¾å®¹å™¨å¯¬åº¦èˆ‡å¯ç”¨é«˜åº¦å–æœ€å°å€¼ï¼Œä¿è­‰æ•´å€‹æ£‹ç›¤ + æŒ‰éˆ•å€å¯å®Œæ•´é¡¯ç¤º
    --------------------------- */
    function fitGridCell() {
      const root = document.documentElement;
      const card = document.querySelector('.card');
      const header = document.querySelector('.header');
      const hero = document.querySelector('.hero');
      const gameWrap = document.querySelector('.game-wrap');
      const actions = document.querySelector('.stage .actions');

      const viewportH = window.innerHeight;
      const viewportW = window.innerWidth;

      // é ä¼°é™¤æ£‹ç›¤å¤–ä½”ç”¨çš„é«˜åº¦ï¼ˆheader + hero + ä¸Šä¸‹ padding + æŒ‰éˆ•å€ç­‰ï¼‰
      const fixedTop = (header?.offsetHeight || 0) + (hero?.offsetHeight || 0) + 40; // 40 buffer
      const fixedBottom = (actions?.offsetHeight || 44) + 40; // 40 buffer

      // å¯ç”¨é«˜åº¦çµ¦æ£‹ç›¤ï¼ˆå« gapsï¼‰
      const availableH = Math.max(200, viewportH - fixedTop - fixedBottom);
      // å¯ç”¨å¯¬åº¦ç‚º game-wrap å…§å±¤å¯¬åº¦ï¼ˆé¿å…è¶…å‡ºå·¦å³é‚Šç•Œï¼‰
      const availableW = Math.min(gameWrap?.clientWidth || viewportW - 32, viewportW - 24);

      // gap æœƒåœ¨å°è¢å¹•ç•¥ç¸®å°
      const gap = viewportW <= 420 ? 4 : 6;

      // ä¾å¯¬åº¦è¨ˆç®—å¯ç”¨ cell å¤§å°ï¼ˆæ‰£é™¤ gapsï¼‰
      const maxCellByW = Math.floor((availableW - (GRID_SIZE - 1) * gap) / GRID_SIZE);
      // ä¾é«˜åº¦è¨ˆç®—å¯ç”¨ cell å¤§å°
      const maxCellByH = Math.floor((availableH - (GRID_SIZE - 1) * gap) / GRID_SIZE);

      // åŸæœ¬è¨­è¨ˆä¸Šé™ 50pxï¼Œä¸‹é™ 34pxï¼›å†å–å¯¬é«˜é™åˆ¶çš„è¼ƒå°å€¼
      const target = Math.max(34, Math.min(50, maxCellByW, maxCellByH));

      root.style.setProperty('--cell', target + 'px');
      root.style.setProperty('--gap', gap + 'px');
      // å­—é«”å¤§å°å¤§ç´„ç‚º cell çš„ 52%
      root.style.setProperty('--cell-font', Math.max(18, Math.round(target * 0.52)) + 'px');
    }

    // ç›£è½å°ºå¯¸
    window.addEventListener('resize', fitGridCell);
    window.addEventListener('orientationchange', () => setTimeout(fitGridCell, 120));
    // åˆæ¬¡å¥—ç”¨
    requestAnimationFrame(fitGridCell);

    /* ---------------------------
       éŠæˆ²ä¸»é‚è¼¯
    --------------------------- */
    function makeCell(x,y,val){
      const d = document.createElement('div');
      d.className = 'cell';
      d.dataset.x = x; d.dataset.y = y;
      d.textContent = val;
      d.addEventListener('click', onCellClick, {passive:true});
      d.addEventListener('touchstart', (e)=>{ e.preventDefault(); onCellClick({target:d}); }, {passive:false});
      return d;
    }

    function render(){
      gridEl.innerHTML = '';
      for(let i=0;i<GRID_SIZE;i++){
        for(let j=0;j<GRID_SIZE;j++){
          const d = makeCell(i,j,grid[i][j]);
          if(selected && selected.x===i && selected.y===j) d.classList.add('selected');
          gridEl.appendChild(d);
        }
      }
      pillScore.textContent = `Scoreï¼š${score} / 200`;
      pillTime.textContent  = `Timeï¼š${timeLeft}s`;
    }

    function initGrid(){
      grid = Array.from({length:GRID_SIZE}, ()=> Array.from({length:GRID_SIZE}, ()=> TYPES[Math.floor(Math.random()*TYPES.length)]));
      // é–‹å±€æ¶ˆé€£
      while (hasMatches()){
        eliminate(false);
        drop();
      }
      render();
      fitGridCell(); // æ¯æ¬¡é‡å»ºå¾Œå†é©é…ä¸€æ¬¡
    }

    function isAdj(a,b){ return (Math.abs(a.x-b.x)===1 && a.y===b.y) || (Math.abs(a.y-b.y)===1 && a.x===b.x); }

    function onCellClick(e){
      if(!running) return;
      const x = +e.target.dataset.x, y = +e.target.dataset.y;
      if(!selected){
        selected = {x,y}; render();
      } else {
        const prev = selected; selected = null;
        if (isAdj({x,y}, prev) && swapAndCheck({x,y}, prev)){
          chainResolve();
        } else render();
      }
    }

    function swapAndCheck(a,b){
      [grid[a.x][a.y], grid[b.x][b.y]] = [grid[b.x][b.y], grid[a.x][a.y]];
      if(!hasMatches()){
        [grid[a.x][a.y], grid[b.x][b.y]] = [grid[b.x][b.y], grid[a.x][a.y]];
        return false;
      }
      return true;
    }

    function hasMatches(){
      for(let i=0;i<GRID_SIZE;i++){
        for(let j=0;j<GRID_SIZE-2;j++){
          if(grid[i][j] && grid[i][j]===grid[i][j+1] && grid[i][j]===grid[i][j+2]) return true;
        }
      }
      for(let j=0;j<GRID_SIZE;j++){
        for(let i=0;i<GRID_SIZE-2;i++){
          if(grid[i][j] && grid[i][j]===grid[i+1][j] && grid[i][j]===grid[i+2][j]) return true;
        }
      }
      return false;
    }

    function eliminate(addScore = true){
      let cleared = 0;
      // æ©«
      for(let i=0;i<GRID_SIZE;i++){
        for(let j=0;j<GRID_SIZE-2;j++){
          const v=grid[i][j];
          if(v && v===grid[i][j+1] && v===grid[i][j+2]){
            let len=3; while(j+len<GRID_SIZE && grid[i][j+len]===v) len++;
            for(let k=0;k<len;k++){ grid[i][j+k]=null; cleared++; }
            if(addScore){ score += 10 + (len>3 ? (len-3)*5 : 0); }
            j += len-1;
          }
        }
      }
      // ç›´
      for(let j=0;j<GRID_SIZE;j++){
        for(let i=0;i<GRID_SIZE-2;i++){
          const v=grid[i][j];
          if(v && v===grid[i+1][j] && v===grid[i+2][j]){
            let len=3; while(i+len<GRID_SIZE && grid[i+len][j]===v) len++;
            for(let k=0;k<len;k++){ grid[i+k][j]=null; cleared++; }
            if(addScore){ score += 10 + (len>3 ? (len-3)*5 : 0); }
            i += len-1;
          }
        }
      }
      return cleared;
    }

    function drop(){
      for(let j=0;j<GRID_SIZE;j++){
        let empty = GRID_SIZE-1;
        for(let i=GRID_SIZE-1;i>=0;i--){
          if(grid[i][j]){
            grid[empty][j]=grid[i][j];
            if(i!==empty) grid[i][j]=null;
            empty--;
          }
        }
        for(let i=0;i<=empty;i++){
          grid[i][j] = TYPES[Math.floor(Math.random()*TYPES.length)];
        }
      }
    }

    function chainResolve(){
      do{
        eliminate(true);
        drop();
      } while (hasMatches());
      render();
      if(score>=200){ unlock(); }
    }

    let tickHandle = null;
    function tick(){
      timeLeft--;
      pillTime.textContent = `Timeï¼š${timeLeft}s`;
      if(timeLeft<=0){ stop('â±ï¸ æ™‚é–“åˆ°ï¼è«‹å†è©¦ä¸€æ¬¡'); return; }
      tickHandle = setTimeout(tick,1000);
    }

    function start(){
      // å…ˆæ¸…é™¤å¯èƒ½çš„æ®˜é¤˜è¨ˆæ™‚
      if(tickHandle){ clearTimeout(tickHandle); tickHandle = null; }

      running = true; score = 0; timeLeft = 30; selected = null;
      pillStatus.textContent='éŠæˆ²é–‹å§‹ï¼'; btnStart.style.display='none'; btnRetry.style.display='none';
      initGrid();
      tickHandle = setTimeout(tick,1000);
    }

    function stop(msg){
      running = false; pillStatus.textContent = msg; btnRetry.style.display='inline-flex';
      if(tickHandle){ clearTimeout(tickHandle); tickHandle = null; }
    }

    function toast(msg){
      const t = document.getElementById('toast'); t.textContent = msg; t.style.display='block';
      setTimeout(()=> t.style.display='none', 1600);
    }

    // âœ… è§£é–å¾Œ 2 ç§’è‡ªå‹•è·³è½‰åˆ°ç²¾éˆé 
    function unlock(){
      running = false;
      const spirit = { id:'spirit_game3', name:'é£²èŒ¶ä»”', image:'images/game-spirit3.png', page:'spirit_game3.html',
        unlockDate:new Date().toISOString(), score:score };
      let spirits = JSON.parse(localStorage.getItem('spirits') || '[]');
      if(!spirits.some(s=>s.id===spirit.id)){
        spirits.push(spirit); localStorage.setItem('spirits', JSON.stringify(spirits));
        toast('ğŸ‰ å·²è§£é–ï¼šé£²èŒ¶ä»”ï¼'); pillStatus.textContent='ğŸ‰ æˆåŠŸè§£é–æŒ‘æˆ°ç²¾éˆï¼šé£²èŒ¶ä»”ï¼';
      } else {
        pillStatus.textContent='ä½ å·²ç¶“è§£é–éé£²èŒ¶ä»”å–‡ï¼';
      }
      btnRetry.style.display='inline-flex';
      setTimeout(()=>{ window.location.href = spirit.page; }, 2000);
    }

    btnStart.addEventListener('click', start);
    btnRetry.addEventListener('click', start);

    // é å…ˆç”Ÿæˆæ£‹ç›¤ï¼ˆæœªé–‹å§‹å¯äº’å‹•æœƒè¢«å¿½ç•¥ï¼‰
    initGrid();
    pillStatus.textContent = 'é»ã€Œé–‹å§‹éŠæˆ²ã€å°±å¯ä»¥ç©å•¦';
  </script>
</body>
</html>
