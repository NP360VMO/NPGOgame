<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æŒ‘æˆ°éŠæˆ²ï½œé£²èŒ¶ä»” åŒ¹é…æŒ‘æˆ°</title>
  <link rel="stylesheet" href="styles.css">
  <style>
.stage{display:flex;flex-direction:column;align-items:center;gap:10px}.grid{display:grid;grid-template-columns:repeat(8, 50px);gap:6px;user-select:none}.cell{
      width:50px;height:50px;display:flex;align-items:center;justify-content:center;
      font-size:26px;background:#ffffff;border:1px solid #e8e2d6;border-radius:10px;
      cursor:pointer;transition:transform .08s ease, box-shadow .12s ease, border-color .12s ease;
      box-shadow:0 2px 8px rgba(0,0,0,.05)
    }.cell:hover{transform:translateY(-1px)}.cell.selected{border:2px solid #ffb547;box-shadow:0 4px 14px rgba(255,181,71,.25)}.cell.clearing{animation:pop .2s ease both, fade .18s ease forwards}
    @keyframes fade{to{opacity:.25; transform:scale(.8);}}@keyframes pop{from{transform:scale(.85);opacity:.4}to{transform:scale(1.1);opacity:1}}

    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:12px}.btn:active{transform:translateY(1px)}.hint{margin-top:4px;color:#7a4a00;font-weight:700}@media (max-width:560px){
      .hero{grid-template-columns:84px 1fr}.grid{gap:5px}.cell{width:44px;height:44px;font-size:24px}
</style>
</head>
<body class="theme-dimsum">
  <div class="container">
    <div class="card">
      <div class="header">
        <div class="title">æŒ‘æˆ°éŠæˆ² - é£²èŒ¶ä»”ï¼ˆåŒ¹é…ï¼‰</div>
        <div class="badge">ğŸ® æŒ‘æˆ°ç³» Â· å‹å‡ºå¯è§£é–</div>
      </div>

      <div class="hero">
        <div class="img-wrap"><img src="images/game-spirit3.png" alt="é£²èŒ¶ä»”"></div>
        <div class="intro">
          <p><strong>ç©æ³•ï¼š</strong>äº¤æ›ç›¸é„°æ ¼å­ï¼Œå½¢æˆ <strong>3 é€£ä»¥ä¸Š</strong> å³æ¶ˆé™¤ï¼›åœ¨é™æ™‚å…§ç´¯ç© <strong>200 åˆ†</strong> è§£é–é£²èŒ¶ä»”ã€‚</p>
          <div class="status-bar">
            <span class="pill info" id="pill-status">å°šæœªé–‹å§‹</span>
            <span class="pill ok" id="pill-score">Scoreï¼š0 / 200</span>
            <span class="pill warn" id="pill-time">Timeï¼š30s</span>
          </div>
          <div class="hint">ğŸ’¡ æç¤ºï¼šä¸€æ¬¡æ¶ˆé™¤è¶…é 3 å€‹æœƒæœ‰åŠ åˆ†ï¼</div>
          <a class="btn secondary" href="game 4_eng.html">ğŸŒ English Version </a>
        </div>
      </div>

      <div class="section">
        <div class="game-wrap">
          <div class="stage">
            <div id="grid" class="grid" aria-label="match-3 grid"></div>
            <div class="actions">
              <button class="btn" id="btn-start">â–¶ï¸ é–‹å§‹éŠæˆ²</button>
              <button class="btn secondary" id="btn-retry" style="display:none;">ğŸ” é‡æ–°é–‹å§‹</button>
            </div>
          </div>
        </div>
        <div class="actions">
          <a class="btn secondary" href="dex.html#dex">ğŸ“– è¿”å›åœ–é‘‘</a>
          <a class="btn secondary" href="index.html">ğŸ”™ è¿”å›ä¸»é </a>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">ğŸ‰ å·²è§£é–ï¼šé£²èŒ¶ä»”ï¼</div>

  <script>
    const GRID_SIZE = 8;
    const TYPES = ['ğŸ¥Ÿ','ğŸ¥®','ğŸ¥ ','ğŸ¡','ğŸ¤'];
    const gridEl = document.getElementById('grid');
    const pillScore = document.getElementById('pill-score');
    const pillTime  = document.getElementById('pill-time');
    const pillStatus= document.getElementById('pill-status');
    const btnStart  = document.getElementById('btn-start');
    const btnRetry  = document.getElementById('btn-retry');

    let grid = [], score = 0, timeLeft = 30, timerId = null, running = false, selected = null;

    function makeCell(x,y,val){
      const d = document.createElement('div');
      d.className = 'cell';
      d.dataset.x = x; d.dataset.y = y;
      d.textContent = val;
      d.addEventListener('click', onCellClick, {passive:true});
      d.addEventListener('touchstart', (e)=>{ e.preventDefault(); onCellClick({target:d}); }, {passive:false});
      return d;
    }

    function render(){
      gridEl.innerHTML = '';
      for(let i=0;i<GRID_SIZE;i++){
        for(let j=0;j<GRID_SIZE;j++){
          const d = makeCell(i,j,grid[i][j]);
          if(selected && selected.x===i && selected.y===j) d.classList.add('selected');
          gridEl.appendChild(d);
        }
      }
      pillScore.textContent = `Scoreï¼š${score} / 200`;
      pillTime.textContent  = `Timeï¼š${timeLeft}s`;
    }

    function initGrid(){
      grid = Array.from({length:GRID_SIZE}, ()=> Array.from({length:GRID_SIZE}, ()=> TYPES[Math.floor(Math.random()*TYPES.length)]));
      // é–‹å±€æ¶ˆé€£
      while (hasMatches()){
        const _tmp=eliminate(false); if(_tmp && _tmp.marks){ for(let i=0;i<GRID_SIZE;i++){ for(let j=0;j<GRID_SIZE;j++){ if(_tmp.marks[i][j]) grid[i][j]=null; } } }
        drop();
      }
      render();
    }

    function isAdj(a,b){ return (Math.abs(a.x-b.x)===1 && a.y===b.y) || (Math.abs(a.y-b.y)===1 && a.x===b.x); }

    function onCellClick(e){
      if(!running) return;
      const x = +e.target.dataset.x, y = +e.target.dataset.y;
      if(!selected){
        selected = {x,y}; render();
      } else {
        const prev = selected; selected = null;
        if (isAdj({x,y}, prev) && swapAndCheck({x,y}, prev)){
          chainResolve();
        } else render();
      }
    }

    function swapAndCheck(a,b){
      [grid[a.x][a.y], grid[b.x][b.y]] = [grid[b.x][b.y], grid[a.x][a.y]];
      if(!hasMatches()){
        [grid[a.x][a.y], grid[b.x][b.y]] = [grid[b.x][b.y], grid[a.x][a.y]];
        return false;
      }
      return true;
    }

    function hasMatches(){
      for(let i=0;i<GRID_SIZE;i++){
        for(let j=0;j<GRID_SIZE-2;j++){
          if(grid[i][j] && grid[i][j]===grid[i][j+1] && grid[i][j]===grid[i][j+2]) return true;
        }
      }
      for(let j=0;j<GRID_SIZE;j++){
        for(let i=0;i<GRID_SIZE-2;i++){
          if(grid[i][j] && grid[i][j]===grid[i+1][j] && grid[i][j]===grid[i+2][j]) return true;
        }
      }
      return false;
    }

    
    function eliminate(addScore = true){
      // phase 1: find matches
      const marks = Array.from({length:GRID_SIZE}, ()=> Array(GRID_SIZE).fill(false));
      let any = false;
      // row
      for(let i=0;i<GRID_SIZE;i++){
        for(let j=0;j<GRID_SIZE-2;j++){
          const v = grid[i][j];
          if(v && v===grid[i][j+1] && v===grid[i][j+2]){
            let len=3; while(j+len<GRID_SIZE && grid[i][j+len]===v) len++;
            for(let k=0;k<len;k++) marks[i][j+k]=true;
            j += len-1; any = true;
          }
        }
      }
      // col
      for(let j=0;j<GRID_SIZE;j++){
        for(let i=0;i<GRID_SIZE-2;i++){
          const v=grid[i][j];
          if(v && v===grid[i+1][j] && v===grid[i+2][j]){
            let len=3; while(i+len<GRID_SIZE && grid[i+len][j]===v) len++;
            for(let k=0;k<len;k++) marks[i+k][j]=true;
            i += len-1; any = true;
          }
        }
      }
      if(!any) return 0;
      // add score & mark DOM
      let cleared = 0;
      for(let i=0;i<GRID_SIZE;i++){
        for(let j=0;j<GRID_SIZE;j++){
          if(marks[i][j]){
            cleared++;
            if(addScore) score += 10; // ç°¡åŒ–ï¼šä¸€æ¬¡ +10ï¼ˆå¯å†ä¾é•·åº¦åŠ æˆï¼‰
          }
        }
      }
      // render with .clearing
      render();
      // add .clearing classes
      document.querySelectorAll('.cell').forEach(d=>{
        const x=+d.dataset.x, y=+d.dataset.y;
        if(marks[x][y]) d.classList.add('clearing');
      });
      return {cleared, marks};
    }


    function drop(){
      for(let j=0;j<GRID_SIZE;j++){
        let empty = GRID_SIZE-1;
        for(let i=GRID_SIZE-1;i>=0;i--){
          if(grid[i][j]){
            grid[empty][j]=grid[i][j];
            if(i!==empty) grid[i][j]=null;
            empty--;
          }
        }
        for(let i=0;i<=empty;i++){
          grid[i][j] = TYPES[Math.floor(Math.random()*TYPES.length)];
        }
      }
    }

    function delay(ms){ return new Promise(res=>setTimeout(res, ms)); }
    async function chainResolve(){
      // é€£æ¶ˆï¼šæœ‰å¾—æ¶ˆå°±æŒçºŒ
      do{
        const res = eliminate(true);
        if(res && res.marks){
          await delay(160);
          // phase 2: null & drop
          for(let i=0;i<GRID_SIZE;i++){
            for(let j=0;j<GRID_SIZE;j++){
              if(res.marks[i][j]) grid[i][j]=null;
            }
          }
          drop();
          render();
          await delay(80);
        }
      } while (hasMatches());
      if(score>=200){ unlock(); }
    }

    function tick(){
      timeLeft--;
      pillTime.textContent = `Timeï¼š${timeLeft}s`;
      if(timeLeft<=0){ stop('â±ï¸ æ™‚é–“åˆ°ï¼è«‹å†è©¦ä¸€æ¬¡'); return; }
      setTimeout(tick,1000);
    }

    function start(){
      running = true; score = 0; timeLeft = 30; selected = null;
      pillStatus.textContent='éŠæˆ²é–‹å§‹ï¼'; btnStart.style.display='none'; btnRetry.style.display='none';
      initGrid();
      setTimeout(tick,1000);
    }

    function stop(msg){
      running = false; pillStatus.textContent = msg; btnRetry.style.display='inline-flex';
    }

    function toast(msg){
      const t = document.getElementById('toast'); t.textContent = msg; t.style.display='block';
      setTimeout(()=> t.style.display='none', 1600);
    }

    // âœ… è§£é–å¾Œ 2 ç§’è‡ªå‹•è·³è½‰åˆ°ç²¾éˆé 
    function unlock(){
      running = false;
      const spirit = { id:'spirit_game3', name:'é£²èŒ¶ä»”', image:'images/game-spirit3.png', page:'spirit_game3.html',
        unlockDate:new Date().toISOString(), score:score };
      let spirits = JSON.parse(localStorage.getItem('spirits') || '[]');
      if(!spirits.some(s=>s.id===spirit.id)){
        spirits.push(spirit); localStorage.setItem('spirits', JSON.stringify(spirits));
        toast('ğŸ‰ å·²è§£é–ï¼šé£²èŒ¶ä»”ï¼'); pillStatus.textContent='ğŸ‰ æˆåŠŸè§£é–æŒ‘æˆ°ç²¾éˆï¼šé£²èŒ¶ä»”ï¼';
      } else {
        pillStatus.textContent='ä½ å·²ç¶“è§£é–éé£²èŒ¶ä»”å–‡ï¼';
      }
      btnRetry.style.display='inline-flex';

      // å»¶é² 2 ç§’è‡ªå‹•è·³è½‰ï¼ˆå¯è‡ªè¡Œæ”¹æ™‚é–“ï¼‰
      setTimeout(()=>{ window.location.href = spirit.page; }, 2000);
    }

    btnStart.addEventListener('click', start);
    btnRetry.addEventListener('click', start);
    // é å…ˆç”Ÿæˆæ£‹ç›¤ï¼ˆæœªé–‹å§‹å¯äº’å‹•æœƒè¢«å¿½ç•¥ï¼‰
    initGrid();
    pillStatus.textContent = 'é»ã€Œé–‹å§‹éŠæˆ²ã€å°±å¯ä»¥ç©å•¦';
  </script>
</body>
</html>
