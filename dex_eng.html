<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NPmon Collection - Ngong Ping 360 GO</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="spirits.js"></script>
  <!-- Include jsQR library -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  
  <style>
    /* Background and base styles */
    body { 
      background-image: linear-gradient(to bottom, rgba(255,255,255,.85), rgba(255,255,255,.75) 30%, rgba(255,255,255,.65) 100%), 
                       url('images/background.png'); 
      background-size: cover; 
      background-position: center; 
      background-repeat: no-repeat; 
      background-attachment: fixed; 
    }
    
    /* Improved title area */
    .dex-hero { 
      text-align: center; 
      padding: clamp(18px, 5vw, 40px) 12px 8px;
      position: relative;
    }
    
    .dex-title { 
      font-size: clamp(28px, 5vw, 42px); 
      font-weight: 900; 
      color: var(--accent-ink); 
      margin: 0 0 6px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      position: relative;
      display: inline-block;
    }
    
    .dex-title::after {
      content: "";
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 4px;
      background: var(--accent);
      border-radius: 2px;
    }
    
    .dex-sub { 
      font-size: clamp(15px, 3.2vw, 18px); 
      color: rgba(0,0,0,.75); 
      margin: 12px auto 20px; 
      max-width: 820px;
      line-height: 1.6;
    }
    
    /* Improved control area */
    .dex-controls { 
      display:flex; 
      gap:12px; 
      justify-content:center; 
      flex-wrap:wrap; 
      margin: 20px 0 16px; 
    }
    
    .dex-search { 
      min-width: 240px; 
      max-width: 460px; 
      width: 70%; 
      position: relative;
    }
    
    .dex-search input { 
      width: 100%; 
      padding: 12px 16px 12px 42px; 
      border-radius: 999px; 
      border: 2px solid var(--section-border); 
      background: rgba(255,255,255,0.9); 
      font-weight: 700; 
      color: var(--ink); 
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
    }
    
    .dex-search input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    }
    
    .dex-search::before {
      content: "\f002";
      font-family: "Font Awesome 6 Free";
      font-weight: 900;
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--accent);
      opacity: 0.7;
    }
    
    .dex-tabs { 
      display:flex; 
      gap:8px; 
      flex-wrap:wrap; 
      justify-content:center; 
    }
    
    .dex-tab { 
      border: 2px solid var(--accent); 
      color: var(--accent-ink); 
      background: transparent; 
      padding: 10px 16px; 
      border-radius: 999px; 
      font-weight: 800; 
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .dex-tab:hover {
      background: rgba(var(--accent-rgb), 0.1);
    }
    
    .dex-tab.active { 
      background: var(--accent); 
      color: #fff; 
      box-shadow: 0 4px 12px rgba(var(--accent-rgb), 0.3);
    }
    
    /* Improved progress bar */
    .dex-progress { 
      background: var(--card); 
      border:1px solid var(--section-border); 
      border-radius: 16px; 
      padding: 16px; 
      box-shadow: 0 8px 24px rgba(0,0,0,.08); 
      max-width: 820px; 
      margin: 0 auto;
    }
    
    .progress { 
      display:flex; 
      align-items:center; 
      gap:12px; 
      justify-content:center; 
      margin: 8px auto 0; 
      flex-wrap: wrap; 
    }
    
    .progress-bar { 
      position:relative; 
      height:14px; 
      width:min(560px, 90%); 
      background:#e9eef5; 
      border-radius:999px; 
      overflow:hidden; 
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .progress-fill { 
      height:100%; 
      width:0%; 
      background: linear-gradient(90deg, var(--accent) 0%, var(--accent-light) 100%);
      transition: width .6s cubic-bezier(0.22, 0.61, 0.36, 1); 
      position: relative;
      overflow: hidden;
    }
    
	.progress-bar { 
		position:relative; 
		height:14px; 
		width:min(560px, 90%); 
		background:#e9eef5; 
		border-radius:999px; 
		overflow:hidden; 
		box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
	}

	.progress-fill { 
		height:100%; 
		width:0%; 
		background: var(--accent);
		transition: width .6s ease;
		border-radius: 999px;
	}
    
    .progress-text { 
      font-weight:800; 
      color:var(--accent-ink); 
      font-size: clamp(14px, 3vw, 16px);
      min-width: 100px;
      text-align: center;
    }
    
    /* Collection content area */
    .dex-wrap { 
      max-width: 1100px; 
      margin: 24px auto 32px; 
      padding: 0 16px; 
    }
    
    .dex-columns { 
      display:grid; 
      grid-template-columns: 1fr; 
      gap: 24px; 
    }
    
    @media (min-width: 920px) { 
      .dex-columns { 
        grid-template-columns: 1fr 1fr; 
        gap: 28px; 
      } 
    }
    
    .dex-sec-title { 
      margin: 0 0 16px; 
      font-size: clamp(18px, 3vw, 22px); 
      color: var(--accent-ink); 
      text-align: center;
      position: relative;
      padding-bottom: 8px;
    }
    
    .dex-sec-title::after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 3px;
      background: var(--accent);
      border-radius: 2px;
    }
    
    .dex-section { 
      background: var(--card); 
      border:1px solid var(--section-border); 
      border-radius: 16px; 
      padding: 20px; 
      box-shadow: 0 8px 24px rgba(0,0,0,.08); 
    }
    
    .dex-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); 
      gap: 18px; 
    }
    
    @media (max-width: 360px) { 
      .dex-grid { 
        grid-template-columns: repeat(2, 1fr); 
        gap: 12px; 
      } 
    }
    
    /* Improved spirit card */
    .dex-card { 
      background: var(--section-bg); 
      border:1px solid var(--section-border); 
      border-radius: 16px; 
      padding: 16px; 
      text-align: center; 
      box-shadow: 0 8px 20px rgba(0,0,0,.08); 
      transition: transform .15s ease, box-shadow .3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .dex-card:hover { 
      transform: translateY(-6px); 
      box-shadow: 0 12px 28px rgba(0,0,0,.15); 
    }
    
    .dex-card img { 
      width: 120px; 
      max-width: 80%; 
      height:auto; 
      filter: drop-shadow(0 8px 18px rgba(0,0,0,.15)); 
      transition: all 0.3s ease;
    }
    
    .dex-card:hover img {
      transform: scale(1.05);
      filter: drop-shadow(0 10px 22px rgba(0,0,0,.2));
    }
    
    .dex-name { 
      margin: 12px 0 4px; 
      font-weight: 900; 
      color: var(--ink); 
      font-size: clamp(14px, 2.8vw, 16px); 
      transition: color 0.3s ease;
    }
    
    .dex-card:hover .dex-name {
      color: var(--accent);
    }
    
    .dex-type { 
      font-size: 13px; 
      color: #7a8699; 
      font-weight: 600;
      background: rgba(var(--accent-rgb), 0.08);
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      transition: all 0.3s ease;
    }
    
    .dex-card:hover .dex-type {
      background: rgba(var(--accent-rgb), 0.15);
      color: var(--accent-ink);
    }
    
    .unknown img { 
      filter: grayscale(100%) brightness(60%); 
    }
    
    .unknown .dex-name { 
      color: #9aa7b1; 
    }
    
    .unknown .dex-type { 
      color: #b8c0c7; 
      background: rgba(0,0,0,0.05);
    }
    
    /* Improved unlock badge */
    .dex-card .ribbon {
      position: absolute; 
      top: 12px; 
      left: -42px;
      transform: rotate(-35deg);
      background: linear-gradient(90deg, var(--accent) 0%, var(--accent-light) 100%);
      color: #fff; 
      font-weight: 900; 
      font-size: 12px;
      padding: 6px 60px; 
      box-shadow: 0 4px 12px rgba(0,0,0,.2);
      letter-spacing: .5px;
      z-index: 10;
    }
    
    .dex-card.unknown .ribbon { display: none; }
    
    /* Improved lock icon */
    .dex-card.unknown::after {
      content: "🔒";
      position: absolute; 
      top: 10px; 
      right: 10px;
      font-size: 20px; 
      opacity: .7; 
      pointer-events: none;
      filter: drop-shadow(0 1px 3px rgba(0,0,0,.15));
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    /* Unlocked card hover effect */
    .dex-card.unknown:hover { 
      box-shadow: 0 12px 28px rgba(0,0,0,.18); 
    }
    
    .dex-card.unknown:hover::after {
      animation: none;
      transform: scale(1.2);
      opacity: 0.9;
    }
    
    .dex-card.unknown img { 
      cursor: pointer; 
    }
    
    /* Improved footer */
    .dex-footer { 
      text-align: center; 
      margin: 28px 0 36px; 
      padding: 0 16px;
    }
    
    .dex-footer .btn {
      padding: 12px 28px;
      border-radius: 30px;
      font-weight: 800;
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
      transition: all 0.3s ease;
    }
    
    .dex-footer .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.18);
    }
    
    /* QR Scanner styles */
    .qr-modal { 
      display: none; 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0,0,0,0.9); 
      z-index: 1000; 
      justify-content: center; 
      align-items: center; 
      flex-direction: column;
    }
    
    .qr-scanner-container { 
      position: relative; 
      width: 80%; 
      max-width: 500px; 
      background: #000; 
      border-radius: 12px; 
      overflow: hidden; 
      box-shadow: 0 0 20px rgba(0,0,0,0.5); 
    }
    
    #qr-video { 
      width: 100%; 
      display: block; 
    }
    
    .qr-scanner-overlay { 
      position: absolute; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      box-sizing: border-box; 
      border: 2px solid #4CAF50; 
      pointer-events: none; 
    }
    
    .qr-scanner-overlay::before { 
      content: ''; 
      position: absolute; 
      top: 50%; 
      left: 50%; 
      width: 70%; 
      height: 70%; 
      transform: translate(-50%, -50%); 
      border: 1px solid rgba(255,255,255,0.5); 
      box-sizing: border-box; 
    }
    
    .qr-scanner-controls { 
      position: absolute; 
      bottom: 0; 
      left: 0; 
      width: 100%; 
      padding: 15px; 
      background: rgba(0,0,0,0.7); 
      display: flex; 
      justify-content: center; 
    }
    
    .qr-close-btn { 
      background: #f44336; 
      color: white; 
      border: none; 
      padding: 10px 20px; 
      border-radius: 5px; 
      cursor: pointer; 
      font-weight: bold; 
    }
    
    .qr-result { 
      position: absolute; 
      top: 20px; 
      left: 0; 
      width: 100%; 
      text-align: center; 
      color: white; 
      font-weight: bold; 
      background: rgba(0,0,0,0.5); 
      padding: 10px; 
    }
    
    .camera-error {
      display: none;
      text-align: center;
      background: #fff4f4;
      color: #dc3545;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
    }
    
    /* Scan button */
    .scan-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      border-radius: 999px;
      border: 2px solid var(--accent);
      background: var(--accent);
      color: white;
      font-weight: 800;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.2s;
      margin-left: 10px;
    }
    
    .scan-btn:hover {
      background: #3a3f99;
      transform: translateY(-2px);
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .dex-search { width: 100%; }
      .dex-controls { gap: 10px; }
      .dex-tab { padding: 8px 14px; }
      .dex-grid { gap: 14px; }
      
      .scan-btn {
        margin-left: 0;
        margin-top: 10px;
      }
    }
    
    @media (max-width: 480px) {
      .dex-title { font-size: 24px; }
      .dex-sub { font-size: 14px; }
      .dex-card { padding: 12px; }
    }
    
    /* Theme color variables */
    .theme-sky {
      --accent-rgb: 86, 170, 255;
      --accent-light: #7ac0ff;
    }
    
    .theme-grass {
      --accent-rgb: 123, 192, 67;
      --accent-light: #8bd46d;
    }
    
    .theme-warm {
      --accent-rgb: 240, 196, 25;
      --accent-light: #f8d44d;
    }
	
	.theme-dimsum { 
      --accent-rgb: 245, 192, 39;
      --accent-light: #F9D775;
    }	
	
	.theme-boba {
      --accent-rgb: 183, 140, 96;
      --accent-light: #DAC4AD;
    }	
  </style>
</head>
<body class="theme-sky">
  <a id="dex"></a>
  <div class="container">
    <div class="dex-hero">
      <div class="dex-title">NPmon Collection</div>
      <div class="dex-sub">Scan the QR codes scattered throughout the enchanting Ngong Ping Village to find all of the NPmon. They are hidden in every corner, are you ready to hunt all of them? You can redeem a mystery PRICE after completing the collection! So what are you waiting for!? Let’s get started!</div>

      <div class="dex-controls">
        <div class="dex-search"><input id="q" type="search" placeholder="Search by name or type…"></div>
        <div class="dex-tabs" id="status-filters">
          <button class="dex-tab active" data-show="all">All</button>
          <button class="dex-tab" data-show="known">Unlocked</button>
          <button class="dex-tab" data-show="unknown">Locked</button>
          <button id="qr-scan-btn" class="scan-btn">📷 Scan QR Code</button>
        </div>
      </div>
    </div>

    <div class="dex-progress">
      <div class="progress">
        <div class="progress-bar"><div id="progress-fill" class="progress-fill"></div></div>
        <div id="progress-text" class="progress-text">0 / 0</div>
      </div>
    </div>
    
    <div class="dex-wrap">
      <div class="dex-columns">
        <section class="dex-section">
          <h3 class="dex-sec-title">Exploration Series</h3>
          <div class="dex-grid" id="dex-explore"></div>
        </section>
        <section class="dex-section">
          <h3 class="dex-sec-title">Challenge Series</h3>
          <div class="dex-grid" id="dex-challenge"></div>
        </section>
      </div>
    </div>

    <div class="dex-footer">
      <a class="btn secondary" href="index_eng.html"><i class="fas fa-arrow-left"></i> Back to Home</a>
       <a class="btn secondary" href="dex.html">🌐 中文</a>
    </div>
  </div>

  <!-- QR Code Scanner Modal -->
  <div id="qr-modal" class="qr-modal">
    <div class="qr-scanner-container">
      <video id="qr-video"></video>
      <div class="qr-scanner-overlay"></div>
      <div class="qr-scanner-controls">
        <button id="qr-close-btn" class="qr-close-btn">Close Camera</button>
      </div>
      <div id="qr-result" class="qr-result"></div>
    </div>
  </div>

  <!-- Camera error message -->
  <div id="camera-error" class="camera-error">
    Unable to start camera. Please ensure you have granted camera permission, or use your phone's built-in QR code scanner for the game.
  </div>

  <script>
    // Theme synchronization
    (function syncTheme(){
      const saved = localStorage.getItem('np_theme');
      if (!saved) return;
      document.body.classList.remove('theme-sky','theme-grass','theme-warm','theme-dimsum','theme-boba');
      document.body.classList.add(saved);
      
      // Set theme color variables
      const root = document.documentElement;
      if (saved === 'theme-sky') {
        root.style.setProperty('--accent-rgb', '86, 170, 255');
        root.style.setProperty('--accent-light', '#7ac0ff');
      } else if (saved === 'theme-grass') {
        root.style.setProperty('--accent-rgb', '123, 192, 67');
        root.style.setProperty('--accent-light', '#8bd46d');
      } else if (saved === 'theme-warm') {
        root.style.setProperty('--accent-rgb', '240, 196, 25');
        root.style.setProperty('--accent-light', '#f8d44d');
      }
    })();

    const allSpirits = window.SPIRITS;
    const gridExplore = document.getElementById('dex-explore');
    const gridChallenge = document.getElementById('dex-challenge');
    const q = document.getElementById('q');
    const statusButtons = Array.from(document.querySelectorAll('#status-filters .dex-tab'));
    const collected = new Set((JSON.parse(localStorage.getItem('spirits') || '[]')).map(s => s.id));
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');

    // --- QR Code scanning functionality ---
    const qrScanBtn = document.getElementById('qr-scan-btn');
    const qrModal = document.getElementById('qr-modal');
    const qrVideo = document.getElementById('qr-video');
    const qrCloseBtn = document.getElementById('qr-close-btn');
    const qrResult = document.getElementById('qr-result');
    const cameraError = document.getElementById('camera-error');
    
    let scanning = false;
    let stream = null;
    
    // Open scanner
    qrScanBtn.addEventListener('click', () => {
      qrModal.style.display = 'flex';
      qrResult.textContent = '';
      startScanning();
    });
    
    // Close scanner
    qrCloseBtn.addEventListener('click', () => {
      stopScanning();
      qrModal.style.display = 'none';
      cameraError.style.display = 'none';
    });
    
    // Start scanning
    async function startScanning() {
      try {
        cameraError.style.display = 'none';
        stream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: "environment" // Use rear camera
          } 
        });
        qrVideo.srcObject = stream;
        await qrVideo.play();
        
        scanning = true;
        requestAnimationFrame(tick);
      } catch (err) {
        console.error("Unable to access camera: ", err);
        cameraError.style.display = 'block';
        qrModal.style.display = 'none';
      }
    }
    
    // Stop scanning
    function stopScanning() {
      scanning = false;
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
    }
    
    // Scanning loop
    function tick() {
      if (!scanning) return;
      
      if (qrVideo.readyState === qrVideo.HAVE_ENOUGH_DATA) {
        const canvas = document.createElement('canvas');
        canvas.width = qrVideo.videoWidth;
        canvas.height = qrVideo.videoHeight;
        const context = canvas.getContext('2d');
        context.drawImage(qrVideo, 0, 0, canvas.width, canvas.height);
        
        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height, {
          inversionAttempts: "dontInvert",
        });
        
        if (code) {
          // Found QR code
          qrResult.textContent = `Found QR code: ${code.data}`;
          
          // Process scanned data
          processQRCode(code.data);
          
          // Pause briefly before continuing
          scanning = false;
          setTimeout(() => {
            scanning = true;
            qrResult.textContent = '';
            requestAnimationFrame(tick);
          }, 2000);
        } else {
          requestAnimationFrame(tick);
        }
      } else {
        requestAnimationFrame(tick);
      }
    }
    
    // Improved URL validation function
    function isValidUrl(string) {
      try {
        // Check if it contains protocol, if not add https://
        if (!string.includes('://')) {
          string = 'https://' + string;
        }
        
        const url = new URL(string);
        
        // Ensure valid domain name
        if (!url.hostname) return false;
        
        // Check common protocols
        const validProtocols = ['http:', 'https:', 'mailto:', 'tel:'];
        if (!validProtocols.includes(url.protocol)) return false;
        
        return true;
      } catch (_) {
        return false;
      }
    }
    
    // Process scanned QR code data
    function processQRCode(data) {
      try {
        // Check if it's a URL
        if (isValidUrl(data)) {
          qrResult.textContent = `Found webpage: ${data}`;
          
          // Show confirmation dialog
          if (confirm(`Scanned webpage address: ${data}\n\nDo you want to visit this page?`)) {
            // Use location.href instead of window.open to avoid popup blocking
            setTimeout(() => {
              window.location.href = data;
            }, 100);
            
            // Optional: Close scanner
            stopScanning();
            qrModal.style.display = 'none';
          }
        } else {
          // Try to parse as JSON (spirit data)
          try {
            const spiritData = JSON.parse(data);
            
            // Check if it contains necessary spirit fields
            if (spiritData.id && spiritData.name) {
              // Add to collection list
              const collectedArray = JSON.parse(localStorage.getItem('spirits') || '[]');
              
              // Check if already collected
              const alreadyCollected = collectedArray.some(s => s.id === spiritData.id);
              
              if (!alreadyCollected) {
                // Add to collection list
                collectedArray.push(spiritData);
                localStorage.setItem('spirits', JSON.stringify(collectedArray));
                
                // Update UI
                collected.add(spiritData.id);
                render(getCurrentFilter(), q.value);
                
                // Show success message
                qrResult.textContent = `Successfully collected: ${spiritData.name}`;
                alert(`🎉 Successfully collected new spirit: ${spiritData.name}`);
              } else {
                qrResult.textContent = `Already collected: ${spiritData.name}`;
                alert(`✅ You have already collected ${spiritData.name}`);
              }
            } else {
              // Not valid spirit data
              qrResult.textContent = `Scanned: ${data}`;
            }
          } catch (jsonError) {
            // Not JSON format, handle as text
            qrResult.textContent = `Scanned: ${data}`;
          }
        }
      } catch (e) {
        console.error("Processing error:", e);
        qrResult.textContent = `Processing error: ${e.message}`;
      }
    }

    // Render function
    function getCurrentFilter() {
      return document.querySelector('#status-filters .dex-tab.active')?.dataset.show || 'all';
    }

    function render(show = 'all', keyword = '') {
      gridExplore.innerHTML = '';
      gridChallenge.innerHTML = '';

      const kw = keyword.trim().toLowerCase();
      const byStatus = (s) => {
        const known = collected.has(s.id);
        if (show === 'known') return known;
        if (show === 'unknown') return !known;
        return true;
      };
      const byKeyword = (s) => kw === '' || s.name.toLowerCase().includes(kw) || s.type.toLowerCase().includes(kw);

      const listExplore = allSpirits.filter(s => s.type === '探索系' && byStatus(s) && byKeyword(s));
      const listChallenge = allSpirits.filter(s => s.type === '🎮 挑戰系' && byStatus(s) && byKeyword(s));

      const buildCard = (s) => {
        const known = collected.has(s.id);
        const card = document.createElement('div');
        card.className = 'dex-card' + (known ? '' : ' unknown');
        card.setAttribute('data-spirit-id', s.id);

        if (known) {
          card.innerHTML = `
            <span class="ribbon">✅ Unlocked</span>
            <a href="${s.page}" style="text-decoration:none; color:inherit;">
              <img src="${s.image}" alt="${s.name}">
              <div class="dex-name">${s.name}</div>
              <div class="dex-type">${s.type}</div>
            </a>`;
        } else {
          card.innerHTML = `
            <img src="${s.image}" alt="???">
            <div class="dex-name">???</div>
            <div class="dex-type">${s.type}</div>`;
          card.querySelector('img').addEventListener('click', () => {
            alert(s.prompt);
          });
        }
        return card;
      };

      listExplore.forEach(s => gridExplore.appendChild(buildCard(s)));
      listChallenge.forEach(s => gridChallenge.appendChild(buildCard(s)));

      // Update progress bar
      const total = allSpirits.length;
      const have = collected.size;
      const pct = Math.min(100, Math.round((have / total) * 100));
      progressFill.style.width = pct + '%';
      progressText.textContent = `${have} / ${total}`;
      
      // Check collection achievements
      if (have === 6) {
        setTimeout(() => {
          alert('🎉 Congratulations on collecting 6 spirits! Go to the Motion 360 Cinema counter to redeem your gift');
        }, 800);
      } else if (have === total) {
        setTimeout(() => {
          alert('🏆 Congratulations on completing the collection! Go to the Motion 360 Cinema counter to redeem your limited edition gift');
        }, 800);
      }
    }

    // Event listeners
    statusButtons.forEach(btn => {
      if (btn.id !== 'qr-scan-btn') {
        btn.addEventListener('click', () => {
          statusButtons.forEach(b => {
            if (b.id !== 'qr-scan-btn') b.classList.remove('active');
          });
          btn.classList.add('active');
          render(btn.dataset.show, q.value);
        });
      }
    });

    q.addEventListener('input', () => {
      const active = document.querySelector('#status-filters .dex-tab.active')?.dataset.show || 'all';
      render(active, q.value);
    });

    // Initial render
    render('all', '');
  </script>
</body>
</html>