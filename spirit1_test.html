<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>精靈介紹 - 纜雲仔（標準形態）</title>
  
  <link rel="stylesheet" href="styles.css">

  <style>
    /* AR modal */
    .ar-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;z-index:1000;padding:16px;}
    .ar-modal{max-width:720px;margin:0 auto;background:#fff;border-radius:16px;overflow:hidden;box-shadow:0 20px 50px rgba(0,0,0,.25);display:flex;flex-direction:column;gap:8px;}
    .ar-head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--section-border);background:var(--card)}
    .ar-title{font-weight:900}
    .ar-close{border:none;background:transparent;font-size:22px;cursor:pointer}
    .camera-wrap{position:relative;border-top:1px solid var(--section-border);background:#000}
    .camera{display:block;width:100%;height:auto;background:#000}
    .overlay{position:absolute;inset:0;touch-action:none}
    .spirit{position:absolute;left:50%;top:60%;transform:translate(-50%,-50%) scale(0.8) rotate(0deg);user-select:none;-webkit-user-drag:none;cursor:grab;filter:drop-shadow(0 8px 18px rgba(0,0,0,.18));max-width:70%}
    .ar-toolbar{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;padding:10px}
    .count-overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;font-weight:900;font-size:96px;color:#fff;text-shadow:0 6px 18px rgba(0,0,0,.5);background:rgba(0,0,0,.25)}
  </style>

<script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
</head>
<body class="theme-sky layout-intro-knowledge-actions">
  <div class="container">
    <div class="card">
      <div class="header">
        <div class="title">精靈介紹 - 纜雲仔（標準形態）</div>
        <div class="badge">天空旅者 · 穩重 · 友善</div>
      </div>

      <div class="hero">
        <div class="img-wrap">
          <img src="images/cablecar-spirit.png" alt="纜雲仔（標準形態）" />
        </div>
        <div class="intro">
          <p><strong>🗺️ 簡介：</strong></p>
          <p>纜雲仔（標準形態）是昂坪最早的守護精靈之一，充滿活力與熱情！它以一輛靈動的纜車形態，每天載著來自五湖四海的旅客，穿越連綿山巒與閃耀海峽，從東涌飛馳至昂坪。</p>
          <p>這段25分鐘的空中旅程，不僅是一場視覺盛宴，更是一次充滿歡笑的歷史探秘！</p>
          <p>纜雲仔是精靈中最健談的一位，總愛用風趣的語調，向旅客訴說昂坪的迷人風光與悠久歷史。從天壇大佛的莊嚴到寶蓮禪寺的靜謐，再到昂坪市集的熱鬧，它的故事總能讓旅人會心一笑，彷彿與大嶼山的靈魂來了一場親密對話。</p>
          <p>無論是俯瞰香港國際機場的飛機起落，還是遠眺山海交融的壯麗，纜雲仔都能讓每位旅客感受到昂坪的獨特魅力！</p>
        </div>
      </div>

      <div class="section knowledge">
        <h3>🗺️ 精靈小知識</h3>
        <p>昂坪360標準纜車以鑽石型設計，四面環窗，讓乘客可360度細心欣賞大嶼山自然景致。</p>
      </div>

      <div class="actions">
        <button class="btn" onclick="collect()">💫 收集精靈</button>
        <button class="btn" id="btn-open-ar">📷 AR 合照</button>

<section class="section">
  <h3 class="sec-title">🧊 3D View / AR 放置</h3>
  <model-viewer
      src="cablecar_spirit_extruded_textured%20(1).glb"
      ios-src="models/cablecar_spirit_extruded_textured.usdz"
      ar
      ar-modes="scene-viewer quick-look"
      camera-controls
      environment-image="neutral"
      shadow-intensity="1"
      style="width:100%;height:400px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.15);">
    <button slot="ar-button" class="btn">🧊 View in AR</button>
  </model-viewer>
</section>

        <a class="btn secondary" href="dex.html">📖 返回圖鑑</a>
      </div>
      <p id="message"></p>

      <div class="footer">
        <a href="index.html">🔙 返回主頁</a>
      </div>
    
  <div class="ar-backdrop" id="ar-backdrop" role="dialog" aria-modal="true" aria-label="AR 合照">
    <div class="ar-modal">
      <div class="ar-head">
        <div class="ar-title">📷 AR 合照</div>
        <button class="ar-close" id="ar-close" aria-label="關閉">✖</button>
      </div>
      <div class="camera-wrap">
        <video id="ar-video" class="camera" playsinline autoplay muted></video>
        <div class="overlay">
          <img id="ar-spirit" class="spirit" src="images/cablecar-spirit.png" alt="纜雲仔（標準形態）">
        </div>
        <div class="count-overlay" id="ar-count"></div>
      </div>
      <div class="ar-toolbar">
        <button class="btn" id="ar-flip">🔄 切換前後鏡</button>
        <button class="btn secondary" id="ar-reset">♻️ 重置位置</button>
        <button class="btn" id="ar-shot">📸 倒數拍照</button>
        <a class="btn secondary" href="dex.html">📖 返回圖鑑</a>
      </div>
    </div>
    <canvas id="ar-canvas" style="display:none"></canvas>
  </div>

  <script>
    const spirit = {
      id: 'spirit1',
      name: '纜雲仔（標準形態）',
      image: 'images/cablecar-spirit.png',
      page: 'spirit1.html'
    };

    function collect() {
      let spirits = JSON.parse(localStorage.getItem('spirits') || '[]');
      if (!spirits.some(s => s.id === spirit.id)) {
        spirits.push(spirit);
        localStorage.setItem('spirits', JSON.stringify(spirits));
        document.getElementById('message').innerText = '🎉 收集成功！返回主頁查看吧！';
      } else {
        document.getElementById('message').innerText = '你已經擁有纜雲仔（標準形態）了喔！';
      }
    }
  
// --- AR Modal Logic (Lite) ---
(function(){
  const openBtn = document.getElementById('btn-open-ar');
  const backdrop = document.getElementById('ar-backdrop');
  const closeBtn = document.getElementById('ar-close');
  const video = document.getElementById('ar-video');
  const canvas = document.getElementById('ar-canvas');
  const spirit = document.getElementById('ar-spirit');
  const flip = document.getElementById('ar-flip');
  const reset = document.getElementById('ar-reset');
  const shot = document.getElementById('ar-shot');
  const count = document.getElementById('ar-count');
  const overlay = backdrop.querySelector('.overlay');
  let usingFront = false, stream = null;
  let base = { x: 0, y: 0, scale: 0.8, rot: 0 }, last = null;

  function apply(){
    spirit.style.transform = `translate(calc(-50% + ${base.x}px), calc(-50% + ${base.y}px)) scale(${base.scale}) rotate(${base.rot}deg)`;
  }

  function startCamera(){
    return (async ()=>{
      if (stream) stream.getTracks().forEach(t=>t.stop());
      try{
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: usingFront ? 'user' : { exact:'environment' }}, audio:false });
      }catch(e){
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: usingFront ? 'user' : 'environment' }, audio:false });
      }
      video.srcObject = stream;
    })();
  }

  function open(){
    backdrop.style.display = 'block';
    document.body.style.overflow = 'hidden';
    startCamera().catch(()=>{
      count.style.display='flex'; count.textContent='相機權限受限'; 
    });
  }
  function close(){
    backdrop.style.display = 'none';
    document.body.style.overflow = '';
    if (stream) stream.getTracks().forEach(t=>t.stop());
    stream = null;
  }

  openBtn && openBtn.addEventListener('click', open);
  closeBtn && closeBtn.addEventListener('click', close);
  backdrop.addEventListener('click', (e)=>{ if (e.target===backdrop) close(); });
  flip.addEventListener('click', ()=>{ usingFront=!usingFront; startCamera(); });
  reset.addEventListener('click', ()=>{ base={x:0,y:0,scale:0.8,rot:0}; apply(); });

  // gestures
  overlay.addEventListener('pointerdown', (e)=>{ e.preventDefault(); overlay.setPointerCapture(e.pointerId); (last||(last=[])).push(e); });
  overlay.addEventListener('pointermove', (e)=>{
    if (!last) return;
    for (let i=0;i<last.length;i++) if (last[i].pointerId===e.pointerId) { last[i]=e; break; }
    if (last.length===1){ base.x += e.movementX; base.y += e.movementY; }
    else if (last.length>=2){
      const [p1,p2] = last; if (!p1||!p2) return;
      if (!overlay._prev){ overlay._prev = { d: Math.hypot(p1.clientX-p2.clientX, p1.clientY-p2.clientY), a: Math.atan2(p2.clientY-p1.clientY, p2.clientX-p1.clientX)}; return; }
      const d = Math.hypot(p1.clientX-p2.clientX, p1.clientY-p2.clientY);
      const a = Math.atan2(p2.clientY-p1.clientY, p2.clientX-p1.clientX);
      const scaleDelta = d/overlay._prev.d; base.scale = Math.min(3, Math.max(0.3, base.scale*scaleDelta));
      base.rot += (a - overlay._prev.a) * 180/Math.PI;
      overlay._prev = { d, a };
    }
    apply();
  });
  function endPointer(e){ if(!last) return; last = last.filter(p=>p.pointerId!==e.pointerId); if (last.length<2) overlay._prev=null; if(!last.length) last=null; }
  overlay.addEventListener('pointerup', endPointer);
  overlay.addEventListener('pointercancel', endPointer);
  overlay.addEventListener('pointerleave', endPointer);

  // countdown + shot
  async function countdownShot(){
    shot.disabled = true;
    const seq = ['3','2','1','📸'];
    count.style.display='flex';
    for (const s of seq){
      count.textContent = s;
      await new Promise(r=>setTimeout(r, 700));
    }
    count.style.display='none';
    // draw
    const w = video.videoWidth, h = video.videoHeight;
    if (!w||!h){ alert('相機尚未啟動'); shot.disabled=false; return; }
    canvas.width=w; canvas.height=h; const ctx=canvas.getContext('2d');
    ctx.drawImage(video,0,0,w,h);
    const img = spirit;
    const spiritDisplayWidth = Math.min(w,h) * 0.7 * base.scale;
    const ratio = img.naturalWidth / img.naturalHeight;
    const dw = spiritDisplayWidth, dh = spiritDisplayWidth/ratio;
    const cx = w/2 + base.x * (w / video.clientWidth);
    const cy = h*0.6 + base.y * (h / video.clientHeight);
    ctx.save(); ctx.translate(cx,cy); ctx.rotate(base.rot * Math.PI/180); ctx.drawImage(img,-dw/2,-dh/2,dw,dh); ctx.restore();
    const a=document.createElement('a'); a.href=canvas.toDataURL('image/png'); a.download='纜雲仔_AR合照.png'; a.click();
    shot.disabled = false;
  }
  shot.addEventListener('click', countdownShot);
})();
</script>
</body>
</html>