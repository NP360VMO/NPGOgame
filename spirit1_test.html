<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç²¾éˆä»‹ç´¹ - çºœé›²ä»”ï¼ˆæ¨™æº–å½¢æ…‹ï¼‰</title>
  
  <link rel="stylesheet" href="styles.css">

  <style>
    /* AR modal */
    .ar-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;z-index:1000;padding:16px;}
    .ar-modal{max-width:720px;margin:0 auto;background:#fff;border-radius:16px;overflow:hidden;box-shadow:0 20px 50px rgba(0,0,0,.25);display:flex;flex-direction:column;gap:8px;}
    .ar-head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--section-border);background:var(--card)}
    .ar-title{font-weight:900}
    .ar-close{border:none;background:transparent;font-size:22px;cursor:pointer}
    .camera-wrap{position:relative;border-top:1px solid var(--section-border);background:#000}
    .camera{display:block;width:100%;height:auto;background:#000}
    .overlay{position:absolute;inset:0;touch-action:none}
    .spirit{position:absolute;left:50%;top:60%;transform:translate(-50%,-50%) scale(0.8) rotate(0deg);user-select:none;-webkit-user-drag:none;cursor:grab;filter:drop-shadow(0 8px 18px rgba(0,0,0,.18));max-width:70%}
    .ar-toolbar{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;padding:10px}
    .count-overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;font-weight:900;font-size:96px;color:#fff;text-shadow:0 6px 18px rgba(0,0,0,.5);background:rgba(0,0,0,.25)}
  </style>

<script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
</head>
<body class="theme-sky layout-intro-knowledge-actions">
  <div class="container">
    <div class="card">
      <div class="header">
        <div class="title">ç²¾éˆä»‹ç´¹ - çºœé›²ä»”ï¼ˆæ¨™æº–å½¢æ…‹ï¼‰</div>
        <div class="badge">å¤©ç©ºæ—…è€… Â· ç©©é‡ Â· å‹å–„</div>
      </div>

      <div class="hero">
        <div class="img-wrap">
          <img src="images/cablecar-spirit.png" alt="çºœé›²ä»”ï¼ˆæ¨™æº–å½¢æ…‹ï¼‰" />
        </div>
        <div class="intro">
          <p><strong>ğŸ—ºï¸ ç°¡ä»‹ï¼š</strong></p>
          <p>çºœé›²ä»”ï¼ˆæ¨™æº–å½¢æ…‹ï¼‰æ˜¯æ˜‚åªæœ€æ—©çš„å®ˆè­·ç²¾éˆä¹‹ä¸€ï¼Œå……æ»¿æ´»åŠ›èˆ‡ç†±æƒ…ï¼å®ƒä»¥ä¸€è¼›éˆå‹•çš„çºœè»Šå½¢æ…‹ï¼Œæ¯å¤©è¼‰è‘—ä¾†è‡ªäº”æ¹–å››æµ·çš„æ—…å®¢ï¼Œç©¿è¶Šé€£ç¶¿å±±å·’èˆ‡é–ƒè€€æµ·å³½ï¼Œå¾æ±æ¶Œé£›é¦³è‡³æ˜‚åªã€‚</p>
          <p>é€™æ®µ25åˆ†é˜çš„ç©ºä¸­æ—…ç¨‹ï¼Œä¸åƒ…æ˜¯ä¸€å ´è¦–è¦ºç››å®´ï¼Œæ›´æ˜¯ä¸€æ¬¡å……æ»¿æ­¡ç¬‘çš„æ­·å²æ¢ç§˜ï¼</p>
          <p>çºœé›²ä»”æ˜¯ç²¾éˆä¸­æœ€å¥è«‡çš„ä¸€ä½ï¼Œç¸½æ„›ç”¨é¢¨è¶£çš„èªèª¿ï¼Œå‘æ—…å®¢è¨´èªªæ˜‚åªçš„è¿·äººé¢¨å…‰èˆ‡æ‚ ä¹…æ­·å²ã€‚å¾å¤©å£‡å¤§ä½›çš„èŠåš´åˆ°å¯¶è“®ç¦ªå¯ºçš„éœè¬ï¼Œå†åˆ°æ˜‚åªå¸‚é›†çš„ç†±é¬§ï¼Œå®ƒçš„æ•…äº‹ç¸½èƒ½è®“æ—…äººæœƒå¿ƒä¸€ç¬‘ï¼Œå½·å½¿èˆ‡å¤§å¶¼å±±çš„éˆé­‚ä¾†äº†ä¸€å ´è¦ªå¯†å°è©±ã€‚</p>
          <p>ç„¡è«–æ˜¯ä¿¯ç°é¦™æ¸¯åœ‹éš›æ©Ÿå ´çš„é£›æ©Ÿèµ·è½ï¼Œé‚„æ˜¯é çœºå±±æµ·äº¤èçš„å£¯éº—ï¼Œçºœé›²ä»”éƒ½èƒ½è®“æ¯ä½æ—…å®¢æ„Ÿå—åˆ°æ˜‚åªçš„ç¨ç‰¹é­…åŠ›ï¼</p>
        </div>
      </div>

      <div class="section knowledge">
        <h3>ğŸ—ºï¸ ç²¾éˆå°çŸ¥è­˜</h3>
        <p>æ˜‚åª360æ¨™æº–çºœè»Šä»¥é‘½çŸ³å‹è¨­è¨ˆï¼Œå››é¢ç’°çª—ï¼Œè®“ä¹˜å®¢å¯360åº¦ç´°å¿ƒæ¬£è³å¤§å¶¼å±±è‡ªç„¶æ™¯è‡´ã€‚</p>
      </div>

      <div class="actions">
        <button class="btn" onclick="collect()">ğŸ’« æ”¶é›†ç²¾éˆ</button>
        <button class="btn" id="btn-open-ar">ğŸ“· AR åˆç…§</button>

<section class="section">
  <h3 class="sec-title">ğŸ§Š 3D View / AR æ”¾ç½®</h3>
  <model-viewer
      src="cablecar_spirit_extruded_textured%20(1).glb"
      ios-src="models/cablecar_spirit_extruded_textured.usdz"
      ar
      ar-modes="scene-viewer quick-look"
      camera-controls
      environment-image="neutral"
      shadow-intensity="1"
      style="width:100%;height:400px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.15);">
    <button slot="ar-button" class="btn">ğŸ§Š View in AR</button>
  </model-viewer>
</section>

        <a class="btn secondary" href="dex.html">ğŸ“– è¿”å›åœ–é‘‘</a>
      </div>
      <p id="message"></p>

      <div class="footer">
        <a href="index.html">ğŸ”™ è¿”å›ä¸»é </a>
      </div>
    
  <div class="ar-backdrop" id="ar-backdrop" role="dialog" aria-modal="true" aria-label="AR åˆç…§">
    <div class="ar-modal">
      <div class="ar-head">
        <div class="ar-title">ğŸ“· AR åˆç…§</div>
        <button class="ar-close" id="ar-close" aria-label="é—œé–‰">âœ–</button>
      </div>
      <div class="camera-wrap">
        <video id="ar-video" class="camera" playsinline autoplay muted></video>
        <div class="overlay">
          <img id="ar-spirit" class="spirit" src="images/cablecar-spirit.png" alt="çºœé›²ä»”ï¼ˆæ¨™æº–å½¢æ…‹ï¼‰">
        </div>
        <div class="count-overlay" id="ar-count"></div>
      </div>
      <div class="ar-toolbar">
        <button class="btn" id="ar-flip">ğŸ”„ åˆ‡æ›å‰å¾Œé¡</button>
        <button class="btn secondary" id="ar-reset">â™»ï¸ é‡ç½®ä½ç½®</button>
        <button class="btn" id="ar-shot">ğŸ“¸ å€’æ•¸æ‹ç…§</button>
        <a class="btn secondary" href="dex.html">ğŸ“– è¿”å›åœ–é‘‘</a>
      </div>
    </div>
    <canvas id="ar-canvas" style="display:none"></canvas>
  </div>

  <script>
    const spirit = {
      id: 'spirit1',
      name: 'çºœé›²ä»”ï¼ˆæ¨™æº–å½¢æ…‹ï¼‰',
      image: 'images/cablecar-spirit.png',
      page: 'spirit1.html'
    };

    function collect() {
      let spirits = JSON.parse(localStorage.getItem('spirits') || '[]');
      if (!spirits.some(s => s.id === spirit.id)) {
        spirits.push(spirit);
        localStorage.setItem('spirits', JSON.stringify(spirits));
        document.getElementById('message').innerText = 'ğŸ‰ æ”¶é›†æˆåŠŸï¼è¿”å›ä¸»é æŸ¥çœ‹å§ï¼';
      } else {
        document.getElementById('message').innerText = 'ä½ å·²ç¶“æ“æœ‰çºœé›²ä»”ï¼ˆæ¨™æº–å½¢æ…‹ï¼‰äº†å–”ï¼';
      }
    }
  
// --- AR Modal Logic (Lite) ---
(function(){
  const openBtn = document.getElementById('btn-open-ar');
  const backdrop = document.getElementById('ar-backdrop');
  const closeBtn = document.getElementById('ar-close');
  const video = document.getElementById('ar-video');
  const canvas = document.getElementById('ar-canvas');
  const spirit = document.getElementById('ar-spirit');
  const flip = document.getElementById('ar-flip');
  const reset = document.getElementById('ar-reset');
  const shot = document.getElementById('ar-shot');
  const count = document.getElementById('ar-count');
  const overlay = backdrop.querySelector('.overlay');
  let usingFront = false, stream = null;
  let base = { x: 0, y: 0, scale: 0.8, rot: 0 }, last = null;

  function apply(){
    spirit.style.transform = `translate(calc(-50% + ${base.x}px), calc(-50% + ${base.y}px)) scale(${base.scale}) rotate(${base.rot}deg)`;
  }

  function startCamera(){
    return (async ()=>{
      if (stream) stream.getTracks().forEach(t=>t.stop());
      try{
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: usingFront ? 'user' : { exact:'environment' }}, audio:false });
      }catch(e){
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: usingFront ? 'user' : 'environment' }, audio:false });
      }
      video.srcObject = stream;
    })();
  }

  function open(){
    backdrop.style.display = 'block';
    document.body.style.overflow = 'hidden';
    startCamera().catch(()=>{
      count.style.display='flex'; count.textContent='ç›¸æ©Ÿæ¬Šé™å—é™'; 
    });
  }
  function close(){
    backdrop.style.display = 'none';
    document.body.style.overflow = '';
    if (stream) stream.getTracks().forEach(t=>t.stop());
    stream = null;
  }

  openBtn && openBtn.addEventListener('click', open);
  closeBtn && closeBtn.addEventListener('click', close);
  backdrop.addEventListener('click', (e)=>{ if (e.target===backdrop) close(); });
  flip.addEventListener('click', ()=>{ usingFront=!usingFront; startCamera(); });
  reset.addEventListener('click', ()=>{ base={x:0,y:0,scale:0.8,rot:0}; apply(); });

  // gestures
  overlay.addEventListener('pointerdown', (e)=>{ e.preventDefault(); overlay.setPointerCapture(e.pointerId); (last||(last=[])).push(e); });
  overlay.addEventListener('pointermove', (e)=>{
    if (!last) return;
    for (let i=0;i<last.length;i++) if (last[i].pointerId===e.pointerId) { last[i]=e; break; }
    if (last.length===1){ base.x += e.movementX; base.y += e.movementY; }
    else if (last.length>=2){
      const [p1,p2] = last; if (!p1||!p2) return;
      if (!overlay._prev){ overlay._prev = { d: Math.hypot(p1.clientX-p2.clientX, p1.clientY-p2.clientY), a: Math.atan2(p2.clientY-p1.clientY, p2.clientX-p1.clientX)}; return; }
      const d = Math.hypot(p1.clientX-p2.clientX, p1.clientY-p2.clientY);
      const a = Math.atan2(p2.clientY-p1.clientY, p2.clientX-p1.clientX);
      const scaleDelta = d/overlay._prev.d; base.scale = Math.min(3, Math.max(0.3, base.scale*scaleDelta));
      base.rot += (a - overlay._prev.a) * 180/Math.PI;
      overlay._prev = { d, a };
    }
    apply();
  });
  function endPointer(e){ if(!last) return; last = last.filter(p=>p.pointerId!==e.pointerId); if (last.length<2) overlay._prev=null; if(!last.length) last=null; }
  overlay.addEventListener('pointerup', endPointer);
  overlay.addEventListener('pointercancel', endPointer);
  overlay.addEventListener('pointerleave', endPointer);

  // countdown + shot
  async function countdownShot(){
    shot.disabled = true;
    const seq = ['3','2','1','ğŸ“¸'];
    count.style.display='flex';
    for (const s of seq){
      count.textContent = s;
      await new Promise(r=>setTimeout(r, 700));
    }
    count.style.display='none';
    // draw
    const w = video.videoWidth, h = video.videoHeight;
    if (!w||!h){ alert('ç›¸æ©Ÿå°šæœªå•Ÿå‹•'); shot.disabled=false; return; }
    canvas.width=w; canvas.height=h; const ctx=canvas.getContext('2d');
    ctx.drawImage(video,0,0,w,h);
    const img = spirit;
    const spiritDisplayWidth = Math.min(w,h) * 0.7 * base.scale;
    const ratio = img.naturalWidth / img.naturalHeight;
    const dw = spiritDisplayWidth, dh = spiritDisplayWidth/ratio;
    const cx = w/2 + base.x * (w / video.clientWidth);
    const cy = h*0.6 + base.y * (h / video.clientHeight);
    ctx.save(); ctx.translate(cx,cy); ctx.rotate(base.rot * Math.PI/180); ctx.drawImage(img,-dw/2,-dh/2,dw,dh); ctx.restore();
    const a=document.createElement('a'); a.href=canvas.toDataURL('image/png'); a.download='çºœé›²ä»”_ARåˆç…§.png'; a.click();
    shot.disabled = false;
  }
  shot.addEventListener('click', countdownShot);
})();
</script>
</body>
</html>