<!doctype html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"/>
  <title>NP360 GO Â· 3D ARï¼ˆBetaï¼‰</title>
  <style>
    html, body { margin:0; padding:0; height:100%; background:#000; color:#fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, PingFang HK, 'Noto Sans CJK HK', 'Microsoft JhengHei', sans-serif;}
    #ui { position: fixed; top: 0; left: 0; right: 0; display:flex; align-items:center; gap:8px; padding:10px env(safe-area-inset-right) 10px env(safe-area-inset-left); background: linear-gradient(to bottom, rgba(0,0,0,0.6), rgba(0,0,0,0)); z-index: 10;}
    .btn { background:#1f2937; border:1px solid #374151; padding:8px 12px; border-radius:12px; color:#fff; font-size:14px;}
    .btn:hover { background:#374151; }
    #footer { position: fixed; bottom: 0; left:0; right:0; display:flex; gap:10px; align-items:center; justify-content:center; padding:14px env(safe-area-inset-right) calc(14px + env(safe-area-inset-bottom)) env(safe-area-inset-left); background: linear-gradient(to top, rgba(0,0,0,0.6), rgba(0,0,0,0)); z-index: 10;}
    #countdown { position: fixed; inset:0; display:none; align-items:center; justify-content:center; font-size:14vw; font-weight:800; color:#fff; text-shadow:0 0 20px rgba(0,0,0,.8); z-index: 20;}
    #reticle { position: fixed; left:50%; top:50%; width:64px; height:64px; margin-left:-32px; margin-top:-32px; border:2px solid rgba(255,255,255,.85); border-radius:50%; box-shadow:0 0 0 2px rgba(0,0,0,.5) inset; pointer-events:none; z-index: 9; display:none;}
    #msg { position: fixed; top: 56px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,.6); padding:8px 12px; border-radius:12px; font-size:13px; display:none; z-index: 15;}
    canvas { display:block; }
  </style>
</head>
<body>
  <div id="ui">
    <button class="btn" onclick="history.back()">â† è¿”å›</button>
    <div style="flex:1"></div>
    <button id="help" class="btn">ä½¿ç”¨æç¤º</button>
  </div>

  <div id="reticle"></div>
  <div id="msg">åœ¨å¯åµæ¸¬çš„å¹³é¢ä¸Šé»ä¸€ä¸‹æ”¾ç½®ç²¾éˆ</div>
  <div id="countdown">3</div>

  <div id="footer">
    <button id="start" class="btn">ğŸ•¶ï¸ é–‹å§‹ 3D AR</button>
    <button id="snap" class="btn" disabled>ğŸ“¸ å€’æ•¸æ‹ç…§</button>
    <button id="clear" class="btn" disabled>ğŸ—‘ ç§»é™¤å…¨éƒ¨</button>
  </div>

  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.160/build/three.module.js';
    import {GLTFLoader} from 'https://unpkg.com/three@0.160/examples/jsm/loaders/GLTFLoader.js';
    import {ARButton} from 'https://unpkg.com/three@0.160/examples/jsm/webxr/ARButton.js';

    const modelURL = './cablecar_spirit_extruded_textured.glb'; // place the GLB alongside this file

    let renderer, scene, camera, reticleMesh;
    let hitTestSource = null, localSpace = null;
    let spirit = null;
    let started = false;

    const startBtn = document.getElementById('start');
    const snapBtn = document.getElementById('snap');
    const clearBtn = document.getElementById('clear');
    const cd = document.getElementById('countdown');
    const msg = document.getElementById('msg');
    const reticleHud = document.getElementById('reticle');

    function initRenderer(){
      renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true, preserveDrawingBuffer:true });
      renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.xr.enabled = true;
      document.body.appendChild(renderer.domElement);
      window.addEventListener('resize', ()=>{
        renderer.setSize(window.innerWidth, window.innerHeight);
      });
    }

    function initScene(){
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 30);
      // soft lights
      scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1.0));
      const dir = new THREE.DirectionalLight(0xffffff, 0.9);
      dir.position.set(1.2, 1.8, 0.8);
      scene.add(dir);

      // reticle mesh (world)
      const geo = new THREE.RingGeometry(0.08, 0.1, 32).rotateX(-Math.PI/2);
      const mat = new THREE.MeshBasicMaterial({ color: 0xffffff });
      reticleMesh = new THREE.Mesh(geo, mat);
      reticleMesh.matrixAutoUpdate = false;
      reticleMesh.visible = false;
      scene.add(reticleMesh);
    }

    async function initAR(){
      document.body.appendChild(ARButton.createButton(renderer, { requiredFeatures: ['hit-test'] }));
      const session = renderer.xr.getSession();
      const viewerSpace = await session.requestReferenceSpace('viewer');
      hitTestSource = await session.requestHitTestSource({ space: viewerSpace });
      localSpace = await session.requestReferenceSpace('local');

      session.addEventListener('end', ()=>{
        startBtn.disabled = false;
        snapBtn.disabled = true;
        clearBtn.disabled = true;
        started = false;
        msg.style.display = 'none';
        reticleHud.style.display = 'none';
      });
    }

    function loadModel(){
      const loader = new GLTFLoader();
      loader.load(modelURL, (gltf)=>{
        spirit = gltf.scene;
        spirit.traverse((n)=>{
          if (n.isMesh) { n.castShadow = true; n.receiveShadow = true; }
        });
      });
    }

    function placeAtReticle(){
      if (!spirit || !reticleMesh.visible) return;
      const clone = spirit.clone();
      clone.position.setFromMatrixPosition(reticleMesh.matrix);
      clone.rotation.y = Math.random()*Math.PI*2;
      scene.add(clone);
      snapBtn.disabled = false;
      clearBtn.disabled = false;
    }

    function clearAll(){
      const toRemove = [];
      scene.traverse((o)=>{ if (o !== reticleMesh && o !== camera && !o.isLight) {
        if (o.type === 'Scene' || o.type === 'Group' || o.isMesh) toRemove.push(o);
      }});
      toRemove.forEach(o=> scene.remove(o));
      snapBtn.disabled = true;
      clearBtn.disabled = true;
    }

    function runCountdownThenSnap(){
      let n = 3;
      cd.textContent = n;
      cd.style.display = 'flex';
      const timer = setInterval(()=>{
        n -= 1;
        if (n <= 0){
          clearInterval(timer);
          cd.style.display = 'none';
          savePNG();
        } else {
          cd.textContent = n;
        }
      }, 1000);
    }

    function savePNG(){
      const a = document.createElement('a');
      a.href = renderer.domElement.toDataURL('image/png');
      a.download = 'np360-ar-photo.png';
      a.click();
    }

    function animate(){
      renderer.setAnimationLoop((t, frame)=>{
        if (frame && hitTestSource && localSpace){
          const hits = frame.getHitTestResults(hitTestSource);
          if (hits.length){
            const pose = hits[0].getPose(localSpace);
            reticleMesh.visible = true;
            reticleMesh.matrix.fromArray(pose.transform.matrix);
            reticleHud.style.display = 'block';
          } else {
            reticleMesh.visible = false;
            reticleHud.style.display = 'none';
          }
        }
        renderer.render(scene, camera);
      });
    }

    // UI events
    document.getElementById('help').addEventListener('click', ()=>{
      alert('æç¤ºï¼š\\n1) é»ã€Œé–‹å§‹ 3D ARã€ä¸¦æˆæ¬Šç›¸æ©Ÿã€‚\\n2) æŠŠæ‰‹æ©Ÿå°æº–åœ°é¢ï¼Œçœ‹åˆ°ç™½è‰²åœ“ç’°å‡ºç¾æ™‚é»ä¸€ä¸‹å³å¯æ”¾ç½®ç²¾éˆã€‚\\n3) å¯æ”¾å¤šå€‹ã€‚\\n4) æŒ‰ã€Œå€’æ•¸æ‹ç…§ã€æœƒ 3-2-1 ä¸¦å­˜ç‚º PNGã€‚\\n5) è‹¥ç„¡æ³•é€²å…¥ ARï¼Œè«‹ä»¥ HTTPS é–‹å•Ÿã€ä½¿ç”¨æ”¯æ´ WebXR çš„æ‰‹æ©Ÿï¼ˆChrome/Androidã€iOS 17+ Safariï¼‰ã€‚');
    });

    startBtn.addEventListener('click', async ()=>{
      if (started) return;
      startBtn.disabled = true;
      initRenderer();
      initScene();
      loadModel();
      await initAR();
      started = true;
      msg.style.display = 'block';
      animate();
    });

    window.addEventListener('click', ()=>{
      if (!started) return;
      placeAtReticle();
    });

    snapBtn.addEventListener('click', runCountdownThenSnap);
    clearBtn.addEventListener('click', clearAll);
  </script>
</body>
</html>
