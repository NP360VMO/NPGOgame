<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>📷 AR 合照</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    body { background: #f6f8fb; }
    .camera-wrap { position: relative; max-width: 640px; margin: 12px auto; border-radius: 16px; overflow: hidden; box-shadow: 0 12px 32px rgba(0,0,0,.12); }
    .camera { display:block; width:100%; height:auto; background:#000; }
    .overlay { position:absolute; left:0; top:0; right:0; bottom:0; overflow:visible; touch-action:none; }
    .spirit { position:absolute; left:50%; top:60%; transform: translate(-50%,-50%) scale(0.8) rotate(0deg); user-select:none; -webkit-user-drag:none; cursor: grab; filter: drop-shadow(0 8px 18px rgba(0,0,0,.18)); max-width: 70%; }
    .hint { text-align:center; color:#5b6b7a; font-weight:700; margin: 8px 0 0; }
    .toolbar { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin-top: 10px; }
    .toolbar .btn { min-width: 120px; }
    .note { text-align:center; color:#7a8699; font-size: 12px; margin-top: 8px; }
    canvas { display:none; }
  </style>
</head>
<body class="theme-sky">
  <div class="container">
    <div class="card">
      <div class="header">
        <div class="title">📷 AR 合照</div>
        <div class="badge">拖動、雙指縮放／旋轉精靈後拍照</div>
      </div>

      <div class="camera-wrap">
        <video id="video" class="camera" playsinline autoplay muted></video>
        <div class="overlay">
          <img id="spirit" class="spirit" src="" alt="spirit">
        </div>
      </div>

      <p id="hint" class="hint">兩指縮放／旋轉；單指拖動位置</p>

      <div class="toolbar">
        <button class="btn" id="btn-flip">🔄 切換前後鏡</button>
        <button class="btn secondary" id="btn-reset">♻️ 重置位置</button>
        <button class="btn" id="btn-shot">📸 拍照下載</button>
        <a class="btn secondary" href="dex.html">📖 返回圖鑑</a>
      </div>
      <p class="note">相片只在本地裝置生成與保存，不會上傳伺服器。</p>

      <div class="actions">
        <a class="btn secondary" href="index.html">← 返回主頁</a>
      </div>
    </div>
  </div>

  <canvas id="canvas"></canvas>

  <script>
    // Read query params: ?img=...&name=...
    const params = new URLSearchParams(location.search);
    const spiritImg = params.get('img') || 'images/cablecar-spirit.png';
    const spiritName = params.get('name') || 'Spirit';

    // Theme sync
    (function syncTheme(){
      const saved = localStorage.getItem('np_theme');
      if (!saved) return;
      document.body.classList.remove('theme-sky','theme-grass','theme-warm','theme-dimsum','theme-boba');
      document.body.classList.add(saved);
    })();

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const spirit = document.getElementById('spirit');
    spirit.src = spiritImg;
    spirit.alt = spiritName;

    let usingFront = false;
    let stream;

    async function startCamera(){
      if (stream) { stream.getTracks().forEach(t => t.stop()); }
      try{
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: usingFront ? 'user' : { exact: 'environment' } },
          audio: false
        });
      } catch(e){
        // Fallback if 'environment' exact not available
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: usingFront ? 'user' : 'environment' },
          audio: false
        });
      }
      video.srcObject = stream;
    }

    document.getElementById('btn-flip').addEventListener('click', ()=>{
      usingFront = !usingFront;
      startCamera();
    });

    document.getElementById('btn-reset').addEventListener('click', ()=>{
      base = { x: 0, y: 0, scale: 0.8, rot: 0 };
      apply();
    });

    // Drag / Pinch / Rotate
    let base = { x: 0, y: 0, scale: 0.8, rot: 0 };
    let last = null;

    function apply(){
      spirit.style.transform = `translate(calc(-50% + ${base.x}px), calc(-50% + ${base.y}px)) scale(${base.scale}) rotate(${base.rot}deg)`;
    }

    function distance(a,b){ return Math.hypot(a.clientX - b.clientX, a.clientY - b.clientY); }
    function angle(a,b){ return Math.atan2(b.clientY - a.clientY, b.clientX - a.clientX) * 180/Math.PI; }

    const overlay = document.querySelector('.overlay');

    overlay.addEventListener('pointerdown', (e)=>{
      e.preventDefault();
      overlay.setPointerCapture(e.pointerId);
      if (!last) last = [];
      last.push(e);
    });
    overlay.addEventListener('pointermove', (e)=>{
      if (!last) return;
      for (let i=0;i<last.length;i++){ if (last[i].pointerId === e.pointerId){ last[i] = e; break; } }
      if (last.length === 1){
        base.x += e.movementX;
        base.y += e.movementY;
      } else if (last.length >= 2){
        const [p1, p2] = last;
        if (!p1 || !p2) return;
        if (!overlay._prev){ overlay._prev = { d: distance(p1,p2), a: angle(p1,p2) }; return; }
        const d = distance(p1,p2);
        const a = angle(p1,p2);
        const scaleDelta = d / overlay._prev.d;
        base.scale = Math.min(3, Math.max(0.3, base.scale * scaleDelta));
        base.rot += (a - overlay._prev.a);
        overlay._prev = { d, a };
      }
      apply();
    });
    function endPointer(e){
      if (!last) return;
      last = last.filter(p => p.pointerId !== e.pointerId);
      if (last.length < 2) overlay._prev = null;
      if (last.length === 0) last = null;
    }
    overlay.addEventListener('pointerup', endPointer);
    overlay.addEventListener('pointercancel', endPointer);
    overlay.addEventListener('pointerleave', endPointer);

    // Shot
    document.getElementById('btn-shot').addEventListener('click', ()=>{
      const w = video.videoWidth;
      const h = video.videoHeight;
      if (!w || !h){ alert('相機尚未啟動，請稍後再試'); return; }
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, w, h);
      const img = spirit;
      const spiritDisplayWidth = Math.min(w,h) * 0.7 * base.scale;
      const ratio = img.naturalWidth / img.naturalHeight;
      const dw = spiritDisplayWidth;
      const dh = spiritDisplayWidth / ratio;
      const cx = w/2 + base.x * (w / video.clientWidth);
      const cy = h*0.6 + base.y * (h / video.clientHeight);
      ctx.save();
      ctx.translate(cx, cy);
      ctx.rotate(base.rot * Math.PI/180);
      ctx.drawImage(img, -dw/2, -dh/2, dw, dh);
      ctx.restore();
      const a = document.createElement('a');
      a.href = canvas.toDataURL('image/png');
      a.download = spiritName + '_ar_photo.png';
      a.click();
    });

    startCamera().catch(()=>{
      document.getElementById('hint').textContent = '⚠️ 無法開啟相機。請確認權限／在 HTTPS 下開啟。';
    });
  </script>

<!-- === Injected 3D AR Button === -->
<style>
  .np360-ar3d-btn{
    position:fixed;right:16px;bottom:16px;z-index:9999;
    background:#0ea5e9;color:#fff;border:none;border-radius:14px;
    padding:12px 16px;font-size:16px;box-shadow:0 6px 16px rgba(0,0,0,.18);
    cursor:pointer
  }
  .np360-ar3d-btn:active{transform:scale(.98)}
</style>
<a class="np360-ar3d-btn" href="ar_photo_3d.html">🕶️ 3D AR 合照</a>
<!-- === /Injected === -->
</body>
</html>
