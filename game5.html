<!DOCTYPE html> 
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>æŠ•é¤µæŒ‘æˆ°ï¼šå¤§é‡‘è‚šé¤“äº†</title>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-B3740R31MS"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-B3740R31MS');

    gtag('event', 'page_enter', {
      'page_title': 'Game 8 - Horizontal Catch Game',
      'page_path': '/game8.html'
    });
  </script>

  <style>
    :root {
      --bg: #f7f3ea;
      --ink: #2f2a25;
      --card: #fffdf9;
      --accent: #ffb547;
      --accent-ink: #6b400a;
      --section-bg: #fff9f0;
      --section-border: #e7d9c5;
      --ok: #15a36d;
      --warn: #e04848;
      --info: #2b6eea;
      --pearl: #f06292;
      --tea: #81c784;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Arial, "PingFang HK", "Microsoft JhengHei", sans-serif;
      background: var(--bg);
      color: var(--ink);
    }
    .container { max-width: 960px; margin: 0 auto; padding: 20px; }
    .card {
      background: var(--card);
      border: 1px solid var(--section-border);
      border-radius: 20px;
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.06);
      overflow: hidden;
    }
    .header {
      display: flex; justify-content: space-between; gap: 12px; align-items: center;
      padding: 18px 20px; border-bottom: 1px solid var(--section-border);
    }
    .title { font-size: 20px; font-weight: 900; letter-spacing: 0.5px; }
    .badge {
      font-weight: 700; background: #fff1d8; border: 1px solid #ffd9a0; color: #7a4a00;
      border-radius: 999px; padding: 6px 10px;
    }
    .hero {
      display: grid; grid-template-columns: 120px 1fr; gap: 14px; padding: 18px 20px;
      border-bottom: 1px solid var(--section-border);
      background: linear-gradient(to bottom, rgba(255, 248, 236, 0.8), rgba(255, 255, 255, 0.6)), url("images/background.png");
      background-size: cover; background-position: center;
    }
    .img-wrap { display: flex; align-items: center; justify-content: center; }
    .img-wrap img { width: 96px; height: auto; filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.12)); }
    .intro p { margin: 0.35rem 0; }
    .status-bar { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px; }
    .pill {
      border: 2px solid var(--section-border); background: #fff; border-radius: 999px;
      padding: 6px 12px; font-weight: 800;
    }
    .pill.ok { border-color: #bfe6d6; color: var(--ok); }
    .pill.warn { border-color: #ffd1d1; color: var(--warn); }
    .pill.info { border-color: #cfe0ff; color: var(--info); }

    .section { padding: 18px 20px; }
    .game-wrap { background: var(--section-bg); border: 1px dashed var(--section-border); border-radius: 16px; padding: 12px; }
    .play-area {
      position: relative; border-radius: 12px; min-height: 360px; max-width: 720px; margin: 0 auto;
      background: #fff; display: flex; flex-direction: column; align-items: center;
    }

    /* éŠæˆ²ç•«å¸ƒ - æ©«å‘å°ºå¯¸ */
    #gameContainer{ 
      max-width:100%; 
      margin:10px auto; 
      position:relative; 
      width:100%;
      display:flex; 
      justify-content:center; 
    }
    #gameCanvas { 
      background-color: #f0f8ff; 
      border: 1px solid #ccc; 
      display:block; 
      max-width:100%; 
      touch-action:none; 
      border-radius: 8px;
    }

    /* é€²åº¦æ¢ */
    .progress { position: relative; width: 100%; height: 8px; background: #f1f1f1; border-radius: 4px; margin-bottom: 12px; }
    .bar { height: 100%; width: 100%; transform-origin: left center; border-radius: 4px; background: linear-gradient(90deg, #81c784, #ffd166); }

    .actions { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-top: 12px; }
    .btn {
      appearance: none; border: 0; cursor: pointer; font-weight: 800; padding: 10px 16px; border-radius: 12px;
      background: var(--accent); color: #fff; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
    }
    .btn.secondary { background: #fff; border: 1px solid var(--section-border); color: var(--ink); }
    .btn:active { transform: translateY(1px); }

    .toast {
      position: fixed; left: 50%; transform: translateX(-50%); bottom: 20px;
      background: var(--accent); color: #fff; padding: 10px 14px; border-radius: 12px; font-weight: 900;
      display: none; z-index: 1000; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.18);
    }

    /* è™›æ“¬æ–¹å‘éµ - å‚ç›´æ’åˆ— */
    #virtualControls { 
      display:flex; 
      justify-content:center; 
      margin-top:16px; 
      flex-direction:column; 
      align-items:center; 
      width:100%; 
    }
    #virtualControls .control-row {
      display:flex;
      justify-content:center;
    }
    #virtualControls .control-btn {
      width:72px; height:72px; border-radius:50%;
      display:flex; justify-content:center; align-items:center; margin:8px;
      font-size:28px; user-select:none; -webkit-tap-highlight-color:transparent;
      border:1px solid var(--section-border); color: var(--ink); font-weight:900; touch-action:manipulation;
      background: rgba(0,0,0,0.06);
    }
    #virtualControls .control-btn:active { background: rgba(0,0,0,0.12); }
    #virtualControls .control-btn:disabled { background: rgba(0,0,0,0.04); cursor: not-allowed; }

    @media (max-width: 560px) {
      .hero { grid-template-columns: 84px 1fr; }
      .img-wrap img { width: 80px; }
      #virtualControls .control-btn { width:64px; height:64px; font-size:24px; margin:6px; }
    }
    
    /* éŠæˆ²èªªæ˜æ¨™ç±¤ */
    .game-tip {
      background: #e8f5e9;
      border-left: 4px solid #4caf50;
      padding: 8px 12px;
      border-radius: 0 8px 8px 0;
      margin: 12px 0;
      font-size: 14px;
    }
    
    /* é›£åº¦æŒ‡ç¤ºå™¨ */
    .difficulty-indicator {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 10px;
      gap: 8px;
      font-size: 14px;
    }
    .difficulty-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: #ddd;
    }
    .difficulty-dot.active {
      background-color: #81c784;
    }
  </style>
</head>
<body class="theme-warm">
  <div class="container">
    <div class="card">
      <div class="header">
        <div class="title">æŠ•é¤µæŒ‘æˆ°:å¤§é‡‘è‚šé¤“äº†</div>
        <div class="badge">ğŸ® æŒ‘æˆ°ç³» Â· å‹å‡ºå¯è§£é–</div>
      </div>

      <div class="hero">
        <div class="img-wrap"><img src="images/game-spirit5.png" alt="å¤§é‡‘" id="spiritImg"></div>
        <div class="intro">
          <p><strong>ç©æ³•ï¼š</strong>ä½¿ç”¨ä¸Šä¸‹éµæˆ–è™›æ“¬æŒ‰éˆ•æ§åˆ¶å¤§é‡‘æ¥ä½å¾å·¦é£›ä¾†çš„å°è‚‰ä¹¾ã€‚åœ¨<strong>60ç§’</strong>å…§æ¥ä½<strong>12å¡Šè‚‰ä¹¾</strong>å³å¯è§£é–å¤§é‡‘ï¼</p>
          <div class="status-bar">
            <span class="pill info" id="pill-status">æº–å‚™é–‹å§‹</span>
            <span class="pill" id="pill-score">åˆ†æ•¸ï¼š0 / 12</span>
            <span class="pill warn" id="pill-timer">å‰©é¤˜æ™‚é–“ï¼š60 ç§’</span>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="game-wrap">
          <div class="play-area">
            <div class="progress"><div class="bar" id="timeBar" style="width: 100%"></div></div>
            <div id="gameContainer">
              <canvas id="gameCanvas"></canvas>
            </div>
            
            <div class="game-tip">ğŸ’¡ æç¤ºï¼šè‚‰ä¹¾é£›è¡Œé€Ÿåº¦æœƒéš¨è‘—æ™‚é–“é€æ¼¸åŠ å¿«</div>
            
            <!-- é›£åº¦æŒ‡ç¤ºå™¨ -->
            <div class="difficulty-indicator">
              <span>é›£åº¦ï¼š</span>
              <div class="difficulty-dot active"></div>
              <div class="difficulty-dot"></div>
              <div class="difficulty-dot"></div>
              <div class="difficulty-dot"></div>
              <div class="difficulty-dot"></div>
            </div>

            <!-- è™›æ“¬æ–¹å‘éµ - å‚ç›´æ’åˆ— -->
            <div id="virtualControls" style="display:none;">
              <div class="control-row">
                <div class="control-btn" id="upBtn">â†‘</div>
              </div>
              <div class="control-row">
                <div class="control-btn" id="downBtn">â†“</div>
              </div>
            </div>
          </div>

          <div class="actions">
            <button class="btn" id="startBtn">â–¶ï¸ é–‹å§‹éŠæˆ²</button>
            <button class="btn secondary" id="retryBtn" style="display:none;">ğŸ” é‡æ–°é–‹å§‹</button>
            <a class="btn secondary" href="dex.html#dex">ğŸ“– è¿”å›åœ–é‘‘</a>
          </div>
        </div>
        <div class="actions"><a class="btn secondary" href="index.html">ğŸ”™ è¿”å›ä¸»é </a></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">ğŸ‰ å·²è§£é–ï¼šå¤§é‡‘ï¼</div>

  <script>
    // éŠæˆ²å¸¸é‡ - æ©«å‘éŠæˆ²
    const CANVAS_WIDTH = 600;
    const CANVAS_HEIGHT = 400;
    
    // èª¿æ•´1ï¼šå¢åŠ ç²¾éˆåœ–ç‰‡å¤§å°ï¼ˆåŸæœ¬40x60ï¼Œç¾åœ¨70x90ï¼‰
    const PLAYER_WIDTH = 40;
    const PLAYER_HEIGHT = 60;
    
    // èª¿æ•´2ï¼šé™ä½ç§»å‹•é€Ÿåº¦ï¼ˆåŸæœ¬6ï¼Œç¾åœ¨5ï¼‰
    const PLAYER_SPEED = 6;
    
    // èª¿æ•´3ï¼šé™ä½çç åˆå§‹é€Ÿåº¦ï¼ˆåŸæœ¬3ï¼Œç¾åœ¨2.5ï¼‰
    const INITIAL_PEARL_SPEED = 2.5;
    
    // èª¿æ•´4ï¼šé™ä½çç æœ€å¤§é€Ÿåº¦ï¼ˆåŸæœ¬8ï¼Œç¾åœ¨6ï¼‰
    const MAX_PEARL_SPEED = 7;
    
    const PEARL_RADIUS = 17; // ç¨å¾®å¢åŠ çç å¤§å°
    
    // èª¿æ•´5ï¼šé™ä½çç ç”Ÿæˆç‡ï¼ˆåŸæœ¬0.025ï¼Œç¾åœ¨0.02ï¼‰
    const PEARL_SPAWN_RATE = 0.02;
    
    // èª¿æ•´6ï¼šé™ä½ç›®æ¨™åˆ†æ•¸ï¼ˆåŸæœ¬15ï¼Œç¾åœ¨12ï¼‰
    const TARGET_SCORE = 12;
    
    const GAME_TIME = 60;
    const PLAYER_X_POSITION = CANVAS_WIDTH - 100; // èª¿æ•´ä½ç½®è®“ç²¾éˆæ›´æ˜é¡¯
    
    // èª¿æ•´7ï¼šå¢åŠ éŒ¯éå®¹è¨±æ¬¡æ•¸ï¼ˆåŸæœ¬5ï¼Œç¾åœ¨8ï¼‰
    const MISSED_LIMIT = 8;

    // å…ƒç´ 
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const pillStatus = document.getElementById('pill-status');
    const pillTimer  = document.getElementById('pill-timer');
    const pillScore  = document.getElementById('pill-score');
    const timeBar    = document.getElementById('timeBar');
    const startBtn   = document.getElementById('startBtn');
    const retryBtn   = document.getElementById('retryBtn');
    const toast      = document.getElementById('toast');
    const upBtn      = document.getElementById('upBtn');
    const downBtn    = document.getElementById('downBtn');
    const virtualControls = document.getElementById('virtualControls');
    const spiritImg = document.getElementById('spiritImg');

    // åœ–ç‰‡è³‡æº - ä½¿ç”¨è‡ªå®šç¾©åœ–ç‰‡
    const backgroundImage = new Image();
    backgroundImage.src = 'images/game-bg.png'; // è‡ªå®šç¾©èƒŒæ™¯åœ–
    
    const pearlImage = new Image();
    pearlImage.src = 'images/pearl.png'; // è‡ªå®šç¾©çç åœ–ç‰‡
    
    const playerImage = new Image();
    playerImage.src = 'images/game-spirit5.png'; // è‡ªå®šç¾©ç²¾éˆåœ–ç‰‡

    // éŠæˆ²ç‹€æ…‹
    let player = {
      x: PLAYER_X_POSITION,
      y: CANVAS_HEIGHT / 2 - PLAYER_HEIGHT / 2,
      width: PLAYER_WIDTH,
      height: PLAYER_HEIGHT,
      speed: PLAYER_SPEED
    };
    
    let pearls = [];
    let score = 0;
    let missed = 0;
    let timeLeft = GAME_TIME;
    let gameOver = false;
    let gameStarted = false;
    let lastSecondTime = 0;
    let pearlSpeed = INITIAL_PEARL_SPEED;
    let keys = { up: false, down: false };
    
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    // åœ–ç‰‡è¼‰å…¥ç‹€æ…‹
    let imagesLoaded = {
      background: false,
      pearl: false,
      player: false
    };
    
    let imagesToLoad = 3;
    let imagesLoadedCount = 0;

    // åˆå§‹åŒ–ç•«å¸ƒ
    function initCanvas() {
      // æ ¹æ“šå®¹å™¨å¤§å°èª¿æ•´ç•«å¸ƒå°ºå¯¸
      const container = document.getElementById('gameContainer');
      const containerWidth = container.clientWidth;
      const maxCanvasWidth = Math.min(containerWidth, 600);
      
      canvas.width = maxCanvasWidth;
      canvas.height = Math.min(maxCanvasWidth * 0.67, 400); // ä¿æŒ16:9æ¯”ä¾‹
      
      // èª¿æ•´ç©å®¶ä½ç½®
      player.x = canvas.width - 100;
      player.y = canvas.height / 2 - player.height / 2;
      
      // é¡¯ç¤ºè™›æ“¬æ§åˆ¶æŒ‰éˆ•
      virtualControls.style.display = isMobile ? 'flex' : 'none';
    }

    // æ™‚é–“æ¢æ›´æ–°
    function updateTimeBar() {
      const percent = (timeLeft / GAME_TIME) * 100;
      timeBar.style.width = percent + '%';
      const hue = Math.max(0, Math.min(120, percent * 1.2));
      timeBar.style.background = `linear-gradient(90deg, hsl(${hue}, 60%, 55%), #ffd166)`;
      
      // æ›´æ–°é›£åº¦æŒ‡ç¤ºå™¨
      updateDifficultyIndicator();
    }
    
    // æ›´æ–°é›£åº¦æŒ‡ç¤ºå™¨
    function updateDifficultyIndicator() {
      const difficultyDots = document.querySelectorAll('.difficulty-dot');
      const timePercent = timeLeft / GAME_TIME;
      
      // æ ¹æ“šå‰©é¤˜æ™‚é–“å’Œå¾—åˆ†æ±ºå®šé›£åº¦ç­‰ç´š
      let difficultyLevel = 1;
      
      if (timePercent < 0.2 || score >= 8) {
        difficultyLevel = 5;
      } else if (timePercent < 0.4 || score >= 6) {
        difficultyLevel = 4;
      } else if (timePercent < 0.6 || score >= 4) {
        difficultyLevel = 3;
      } else if (timePercent < 0.8 || score >= 2) {
        difficultyLevel = 2;
      }
      
      // æ›´æ–°é»é»é¡è‰²
      difficultyDots.forEach((dot, index) => {
        if (index < difficultyLevel) {
          dot.classList.add('active');
        } else {
          dot.classList.remove('active');
        }
      });
    }

    // åˆå§‹åŒ–éŠæˆ²
    function initializeGame() {
      initCanvas();
      window.addEventListener('resize', initCanvas);
      resetGameState();

      // éµç›¤äº‹ä»¶
      document.addEventListener('keydown', handleKeyDown);
      document.addEventListener('keyup', handleKeyUp);

      // é–‹å§‹æŒ‰éˆ•
      startBtn.addEventListener('click', startGame);
      startBtn.addEventListener('touchstart', (e) => { 
        e.preventDefault(); 
        startGame(); 
      });

      // é‡è©¦æŒ‰éˆ•
      retryBtn.addEventListener('click', () => {
        resetGameState(); 
        startGame(); 
        lastSecondTime = 0;
      });

      // è™›æ“¬æŒ‰éˆ•äº‹ä»¶ - ä¸Šä¸‹æ§åˆ¶
      upBtn.addEventListener('touchstart', (e) => { 
        e.preventDefault(); 
        if (gameStarted && !gameOver) {
          keys.up = true;
          keys.down = false;
        }
      });
      
      downBtn.addEventListener('touchstart', (e) => { 
        e.preventDefault(); 
        if (gameStarted && !gameOver) {
          keys.down = true;
          keys.up = false;
        }
      });
      
      upBtn.addEventListener('touchend', (e) => { 
        e.preventDefault(); 
        keys.up = false;
      });
      
      downBtn.addEventListener('touchend', (e) => { 
        e.preventDefault(); 
        keys.down = false;
      });
      
      upBtn.addEventListener('click', () => { 
        if (gameStarted && !gameOver) {
          keys.up = true;
          keys.down = false;
          setTimeout(() => { keys.up = false; }, 100);
        }
      });
      
      downBtn.addEventListener('click', () => { 
        if (gameStarted && !gameOver) {
          keys.down = true;
          keys.up = false;
          setTimeout(() => { keys.down = false; }, 100);
        }
      });

      // æ»‘å‹•æ‰‹å‹¢æ§åˆ¶ - å‚ç›´æ»‘å‹•
      let touchStartY = 0;
      canvas.addEventListener('touchstart', (e) => {
        if (!gameStarted || gameOver) return;
        e.preventDefault();
        const t = e.touches[0];
        touchStartY = t.clientY;
      }, { passive: false });
      
      canvas.addEventListener('touchmove', (e) => {
        if (gameStarted && !gameOver) e.preventDefault();
      }, { passive: false });
      
      canvas.addEventListener('touchend', (e) => {
        if (!gameStarted || gameOver || !touchStartY) return;
        e.preventDefault();
        const t = (e.changedTouches && e.changedTouches[0]) || null;
        if (!t) return;
        
        const dy = t.clientY - touchStartY;
        const MIN_DIST = 20;
        
        if (Math.abs(dy) > MIN_DIST) {
          if (dy > 0) {
            keys.down = true;
            keys.up = false;
          } else {
            keys.up = true;
            keys.down = false;
          }
          // çŸ­æš«ä¿æŒç§»å‹•æ–¹å‘
          setTimeout(() => {
            keys.up = false;
            keys.down = false;
          }, 100);
        }
        
        touchStartY = 0;
      }, { passive: false });

      // è¼‰å…¥åœ–ç‰‡
      loadImages();
    }

    // è¼‰å…¥åœ–ç‰‡
    function loadImages() {
      // èƒŒæ™¯åœ–ç‰‡
      backgroundImage.onload = function() {
        imagesLoaded.background = true;
        imagesLoadedCount++;
        checkAllImagesLoaded();
      };
      backgroundImage.onerror = function() {
        console.error('èƒŒæ™¯åœ–ç‰‡è¼‰å…¥å¤±æ•—');
        imagesLoaded.background = false;
        imagesLoadedCount++;
        checkAllImagesLoaded();
      };
      
      // çç åœ–ç‰‡
      pearlImage.onload = function() {
        imagesLoaded.pearl = true;
        imagesLoadedCount++;
        checkAllImagesLoaded();
      };
      pearlImage.onerror = function() {
        console.error('å¤§é‡‘è¼‰å…¥å¤±æ•—');
        imagesLoaded.pearl = false;
        imagesLoadedCount++;
        checkAllImagesLoaded();
      };
      
      // ç©å®¶åœ–ç‰‡
      playerImage.onload = function() {
        imagesLoaded.player = true;
        imagesLoadedCount++;
        checkAllImagesLoaded();
      };
      playerImage.onerror = function() {
        console.error('åœ–ç‰‡è¼‰å…¥å¤±æ•—');
        imagesLoaded.player = false;
        imagesLoadedCount++;
        checkAllImagesLoaded();
      };
    }
    
    // æª¢æŸ¥æ‰€æœ‰åœ–ç‰‡æ˜¯å¦è¼‰å…¥å®Œæˆ
    function checkAllImagesLoaded() {
      if (imagesLoadedCount === imagesToLoad) {
        // æ‰€æœ‰åœ–ç‰‡è¼‰å…¥å®Œæˆæˆ–è¼‰å…¥å¤±æ•—
        renderGame();
      }
    }

    // é‡ç½®éŠæˆ²ç‹€æ…‹
    function resetGameState() {
      player.y = CANVAS_HEIGHT / 2 - PLAYER_HEIGHT / 2;
      pearls = [];
      score = 0;
      missed = 0;
      timeLeft = GAME_TIME;
      gameOver = false;
      gameStarted = false;
      pearlSpeed = INITIAL_PEARL_SPEED;
      keys = { up: false, down: false };

      pillStatus.textContent = 'æº–å‚™é–‹å§‹';
      pillStatus.className = 'pill info';
      pillTimer.textContent = `å‰©é¤˜æ™‚é–“ï¼š${timeLeft} ç§’`;
      pillScore.textContent = `åˆ†æ•¸ï¼š${score} / ${TARGET_SCORE}`;

      startBtn.style.display = 'inline-flex';
      retryBtn.style.display = 'none';

      upBtn.disabled = false;
      downBtn.disabled = false;

      updateTimeBar();
    }

    // é–‹å§‹éŠæˆ²
    function startGame() {
      if (!gameStarted && !gameOver) {
        gameStarted = true;
        startBtn.style.display = 'none';
        retryBtn.style.display = 'inline-flex';
        pillStatus.textContent = 'éŠæˆ²é€²è¡Œä¸­';
        pillStatus.className = 'pill ok';
        upBtn.disabled = false;
        downBtn.disabled = false;
        lastSecondTime = performance.now();
        gameLoop();
      }
    }

    // éµç›¤æŒ‰ä¸‹
    function handleKeyDown(e) {
      if (!gameStarted && !gameOver && (e.key === 'ArrowUp' || e.key === 'ArrowDown')) {
        startGame();
      }
      
      if (gameStarted && !gameOver) {
        if (e.key === 'ArrowUp' || e.key === 'w' || e.key === 'W') {
          keys.up = true;
          keys.down = false;
        } else if (e.key === 'ArrowDown' || e.key === 's' || e.key === 'S') {
          keys.down = true;
          keys.up = false;
        }
      }
    }

    // éµç›¤é‡‹æ”¾
    function handleKeyUp(e) {
      if (e.key === 'ArrowUp' || e.key === 'w' || e.key === 'W') {
        keys.up = false;
      } else if (e.key === 'ArrowDown' || e.key === 's' || e.key === 'S') {
        keys.down = false;
      }
    }

    // æ›´æ–°ç©å®¶ä½ç½® - å‚ç›´ç§»å‹•
    function updatePlayer() {
      if (keys.up && player.y > 0) {
        player.y -= player.speed;
      }
      if (keys.down && player.y < canvas.height - player.height) {
        player.y += player.speed;
      }
    }

    // ç”Ÿæˆçç  - å¾å·¦å´éš¨æ©Ÿé«˜åº¦ç”Ÿæˆ
    function generatePearl() {
      // èª¿æ•´ï¼šéŠæˆ²åˆæœŸç”Ÿæˆç‡æ›´ä½
      let currentSpawnRate = PEARL_SPAWN_RATE;
      if (timeLeft > 45) currentSpawnRate *= 0.7; // å‰15ç§’ç”Ÿæˆç‡æ›´ä½
      
      if (Math.random() < currentSpawnRate) {
        pearls.push({
          x: -PEARL_RADIUS * 2,
          y: Math.random() * (canvas.height - PEARL_RADIUS * 2) + PEARL_RADIUS,
          radius: PEARL_RADIUS,
          speed: pearlSpeed + Math.random() * 1.0, // æ¸›å°‘éš¨æ©Ÿè®ŠåŒ–
          color: `hsl(${Math.random() * 60 + 300}, 70%, 60%)` // ç²‰ç´…è‰²ç³»
        });
      }
    }

    // æ›´æ–°çç ä½ç½® - å¾å·¦å‘å³ç§»å‹•
    function updatePearls() {
      for (let i = pearls.length - 1; i >= 0; i--) {
        const pearl = pearls[i];
        pearl.x += pearl.speed;

        // æª¢æ¸¬æ˜¯å¦æ¥åˆ°çç 
        // çç èˆ‡ç©å®¶ç²¾éˆç¢°æ’æª¢æ¸¬ - ä½¿ç”¨æ›´å¯¬é¬†çš„æª¢æ¸¬
        const playerCenterX = player.x + player.width / 2;
        const playerCenterY = player.y + player.height / 2;
        
        // èª¿æ•´ï¼šå¢åŠ æ¥å–ç¯„åœï¼ˆç¢°æ’æª¢æ¸¬æ›´å¯¬é¬†ï¼‰
        const catchWidth = player.width * 1.2;
        const catchHeight = player.height * 1.2;
        
        if (pearl.x >= player.x - 10 && 
            pearl.x <= player.x + player.width + 10 && 
            pearl.y >= player.y - 10 && 
            pearl.y <= player.y + player.height + 10) {
          pearls.splice(i, 1);
          score++;
          pillScore.textContent = `åˆ†æ•¸ï¼š${score} / ${TARGET_SCORE}`;
          
          // æ’­æ”¾å¾—åˆ†éŸ³æ•ˆï¼ˆå¯é¸ï¼‰
          playScoreSound();
          
          if (score >= TARGET_SCORE) {
            unlockSpirit();
            gameOver = true;
            return;
          }
          
          // èª¿æ•´ï¼šæ¯å¾—4åˆ†å¢åŠ é€Ÿåº¦ï¼ˆåŸæœ¬5åˆ†ï¼‰
          if (score % 4 === 0 && pearlSpeed < MAX_PEARL_SPEED) {
            pearlSpeed += 0.3; // å¢åŠ å¹…åº¦æ›´å°
          }
          continue;
        }

        // çç é£›å‡ºå³å´é‚Šç•Œ
        if (pearl.x > canvas.width + pearl.radius) {
          pearls.splice(i, 1);
          missed++;
          
          if (missed >= MISSED_LIMIT) {
            gameOver = true;
            pillStatus.textContent = 'éŠæˆ²çµæŸ';
            pillStatus.className = 'pill warn';
            showToast(`éŠæˆ²çµæŸï¼æ¥ä½: ${score}é¡†ï¼ŒéŒ¯é: ${missed}é¡†`);
            return;
          }
        }
      }
    }
    
    // æ’­æ”¾å¾—åˆ†éŸ³æ•ˆï¼ˆç°¡å–®çš„beepéŸ³æ•ˆï¼‰
    function playScoreSound() {
      try {
        // å‰µå»ºä¸€å€‹ç°¡å–®çš„Web Audio APIéŸ³æ•ˆ
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800 + score * 20; // éŸ³èª¿éš¨åˆ†æ•¸å¢åŠ 
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.1);
      } catch (e) {
        // å¦‚æœéŸ³æ•ˆå¤±æ•—ï¼Œéœé»˜è™•ç†
        console.log("éŸ³æ•ˆæ’­æ”¾å¤±æ•—ï¼Œä½†ä¸å½±éŸ¿éŠæˆ²");
      }
    }

    // ç¹ªè£½éŠæˆ²
    function renderGame() {
      // æ¸…é™¤ç•«å¸ƒ
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // ç¹ªè£½èƒŒæ™¯ - ä½¿ç”¨è‡ªå®šç¾©èƒŒæ™¯åœ–
      if (imagesLoaded.background && backgroundImage.complete) {
        // ç¹ªè£½èƒŒæ™¯åœ–ï¼ˆå¹³é‹ªæˆ–æ‹‰ä¼¸ä»¥é©æ‡‰ç•«å¸ƒï¼‰
        ctx.drawImage(backgroundImage, 0, 0, canvas.width, canvas.height);
      } else {
        // å¦‚æœèƒŒæ™¯åœ–æœªè¼‰å…¥ï¼Œä½¿ç”¨é è¨­èƒŒæ™¯
        ctx.fillStyle = '#e3f2fd';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // ç¹ªè£½ç°¡å–®çš„ç¶²æ ¼èƒŒæ™¯
        drawGrid();
      }
      
      // ç¹ªè£½é£›è¡Œè»Œè·¡ç·šï¼ˆå¾å·¦åˆ°å³ï¼‰
      drawFlightPath();
      
      // ç¹ªè£½çç  - ä½¿ç”¨è‡ªå®šç¾©çç åœ–ç‰‡
      pearls.forEach(pearl => {
        if (imagesLoaded.pearl && pearlImage.complete) {
          // ä½¿ç”¨çç åœ–ç‰‡
          const pearlSize = pearl.radius * 2;
          ctx.drawImage(
            pearlImage, 
            pearl.x - pearl.radius, 
            pearl.y - pearl.radius, 
            pearlSize, 
            pearlSize
          );
          
          // çç å°¾éƒ¨è»Œè·¡æ•ˆæœ
          ctx.save();
          ctx.beginPath();
          ctx.moveTo(pearl.x - pearl.radius * 2, pearl.y);
          ctx.lineTo(pearl.x, pearl.y);
          ctx.strokeStyle = 'rgba(240, 98, 146, 0.4)';
          ctx.lineWidth = 3;
          ctx.stroke();
          ctx.restore();
        } else {
          // å¦‚æœçç åœ–ç‰‡æœªè¼‰å…¥ï¼Œä½¿ç”¨ç¹ªè£½çš„çç 
          drawPearlGraphic(pearl);
        }
      });
      
      // ç¹ªè£½ç©å®¶ç²¾éˆ - ä½¿ç”¨è‡ªå®šç¾©ç²¾éˆåœ–ç‰‡
      drawPlayer();
      
      // ç¹ªè£½åˆ†æ•¸å’ŒéŒ¯éæ•¸
      ctx.fillStyle = '#333';
      ctx.font = 'bold 16px Arial';
      ctx.fillText(`æ¥ä½: ${score}`, 10, 25);
      ctx.fillText(`éŒ¯é: ${missed}/${MISSED_LIMIT}`, 10, 50);
      ctx.fillText(`é€Ÿåº¦: ${pearlSpeed.toFixed(1)}`, canvas.width - 100, 25);
      
      // ç¹ªè£½ç›®æ¨™ç·šï¼ˆå³å´ï¼‰
      ctx.strokeStyle = '#ff6b6b';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(player.x - 10, 0);
      ctx.lineTo(player.x - 10, canvas.height);
      ctx.stroke();
      
      // æ¨™ç¤º"æ¥å–å€"
      ctx.fillStyle = '#ff6b6b';
      ctx.font = 'bold 14px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('æ¥å–å€', player.x - 10, canvas.height - 10);
      
      // éŠæˆ²ç‹€æ…‹æç¤º
      if (!gameStarted && !gameOver) {
        ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 24px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('é»æ“Šé–‹å§‹éŠæˆ²', canvas.width/2, canvas.height/2);
        ctx.font = '16px Arial';
        ctx.fillText('ä½¿ç”¨ä¸Šä¸‹éµæˆ–æŒ‰éˆ•æ§åˆ¶å¤§é‡‘ç§»å‹•', canvas.width/2, canvas.height/2 + 40);
        ctx.fillText(`ç›®æ¨™ï¼š${TARGET_SCORE}å¡Šè‚‰ä¹¾ï¼Œå®¹éŒ¯ï¼š${MISSED_LIMIT}å¡Š`, canvas.width/2, canvas.height/2 + 70);
      }
      
      if (gameOver) {
        ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 24px Arial';
        ctx.textAlign = 'center';
        
        if (score >= TARGET_SCORE) {
          ctx.fillText('æŒ‘æˆ°æˆåŠŸï¼', canvas.width/2, canvas.height/2 - 30);
          ctx.font = '20px Arial';
          ctx.fillText(`æ¥ä½ ${score} å¡Šè‚‰ä¹¾`, canvas.width/2, canvas.height/2);
          ctx.font = '18px Arial';
          ctx.fillText('è§£é–ç²¾éˆä¸­...', canvas.width/2, canvas.height/2 + 40);
        } else {
          ctx.fillText('éŠæˆ²çµæŸ', canvas.width/2, canvas.height/2 - 30);
          ctx.font = '18px Arial';
          ctx.fillText(`æœ€çµ‚åˆ†æ•¸: ${score} / ${TARGET_SCORE}`, canvas.width/2, canvas.height/2);
          ctx.font = '16px Arial';
          ctx.fillText('é»æ“Šé‡æ–°é–‹å§‹æŒ‰éˆ•å†è©¦ä¸€æ¬¡', canvas.width/2, canvas.height/2 + 40);
        }
      }
    }
    
    // ç¹ªè£½çç åœ–å½¢ï¼ˆå¦‚æœåœ–ç‰‡æœªè¼‰å…¥ï¼‰
    function drawPearlGraphic(pearl) {
      ctx.save();
      ctx.beginPath();
      ctx.arc(pearl.x, pearl.y, pearl.radius, 0, Math.PI * 2);
      ctx.fillStyle = pearl.color;
      ctx.fill();
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 2;
      ctx.stroke();
      
      // çç é«˜å…‰
      ctx.beginPath();
      ctx.arc(pearl.x - pearl.radius * 0.3, pearl.y - pearl.radius * 0.3, pearl.radius * 0.3, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
      ctx.fill();
      ctx.restore();
    }
    
    // ç¹ªè£½ç©å®¶ç²¾éˆï¼ˆä½¿ç”¨è‡ªå®šç¾©åœ–ç‰‡ï¼‰
    function drawPlayer() {
      ctx.save();
      
      // ç¹ªè£½ç²¾éˆåœ–ç‰‡ï¼ˆå¦‚æœå¯ç”¨ï¼‰
      if (imagesLoaded.player && playerImage.complete) {
        // ä¿æŒåœ–ç‰‡æ¯”ä¾‹ï¼Œè¨ˆç®—åˆé©çš„ç¹ªè£½å°ºå¯¸
        const imgAspectRatio = playerImage.naturalWidth / playerImage.naturalHeight;
        let drawWidth = player.width;
        let drawHeight = player.height;
        
        // æ ¹æ“šåœ–ç‰‡æ¯”ä¾‹èª¿æ•´ï¼Œä¿æŒæ¯”ä¾‹
        if (imgAspectRatio > 1) {
          // å¯¬åœ–ï¼Œä»¥å¯¬åº¦ç‚ºåŸºæº–
          drawHeight = drawWidth / imgAspectRatio;
        } else {
          // é«˜åœ–ï¼Œä»¥é«˜åº¦ç‚ºåŸºæº–
          drawWidth = drawHeight * imgAspectRatio;
        }
        
        // å±…ä¸­ç¹ªè£½
        const drawX = player.x + (player.width - drawWidth) / 2;
        const drawY = player.y + (player.height - drawHeight) / 2;
        
        ctx.drawImage(playerImage, drawX, drawY, drawWidth, drawHeight);
        
        // ç¹ªè£½ç²¾éˆè¼ªå»“ï¼ˆå¯é¸ï¼‰
        ctx.strokeStyle = 'rgba(76, 175, 80, 0.5)';
        ctx.lineWidth = 3;
        ctx.strokeRect(drawX, drawY, drawWidth, drawHeight);
      } else {
        // å¦‚æœåœ–ç‰‡ä¸å¯ç”¨ï¼Œç¹ªè£½æ›¿ä»£åœ–å½¢
        drawPlayerGraphic();
      }
      
      // ç¹ªè£½ç§»å‹•æ–¹å‘æŒ‡ç¤ºå™¨
      if (keys.up || keys.down) {
        ctx.fillStyle = keys.up ? '#4CAF50' : '#FF9800';
        ctx.beginPath();
        const arrowX = player.x + player.width / 2;
        const arrowY = keys.up ? player.y - 10 : player.y + player.height + 10;
        const arrowSize = 8;
        
        if (keys.up) {
          // å‘ä¸Šç®­é ­
          ctx.moveTo(arrowX, arrowY);
          ctx.lineTo(arrowX - arrowSize, arrowY + arrowSize);
          ctx.lineTo(arrowX + arrowSize, arrowY + arrowSize);
        } else {
          // å‘ä¸‹ç®­é ­
          ctx.moveTo(arrowX, arrowY);
          ctx.lineTo(arrowX - arrowSize, arrowY - arrowSize);
          ctx.lineTo(arrowX + arrowSize, arrowY - arrowSize);
        }
        ctx.closePath();
        ctx.fill();
      }
      
      ctx.restore();
    }
    
    // ç¹ªè£½ç©å®¶æ›¿ä»£åœ–å½¢
    function drawPlayerGraphic() {
      // æ›´å¤§çš„æ›¿ä»£åœ–å½¢
      ctx.fillStyle = '#ffb547';
      ctx.beginPath();
      // ä½¿ç”¨ roundRect å¦‚æœæ”¯æ´ï¼Œå¦å‰‡ä½¿ç”¨ rect
      if (ctx.roundRect) {
        ctx.roundRect(player.x, player.y, player.width, player.height, 15);
      } else {
        ctx.rect(player.x, player.y, player.width, player.height);
      }
      ctx.fill();
      
      // æ·»åŠ æ¼¸è®Šæ•ˆæœ
      const gradient = ctx.createLinearGradient(
        player.x, player.y, 
        player.x, player.y + player.height
      );
      gradient.addColorStop(0, '#ffb547');
      gradient.addColorStop(1, '#ff9800');
      ctx.fillStyle = gradient;
      ctx.fill();
      
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 18px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('ç²¾éˆ', player.x + player.width/2, player.y + player.height/2);
      
      // æ·»åŠ é™°å½±æ•ˆæœ
      ctx.strokeStyle = '#ff9800';
      ctx.lineWidth = 3;
      ctx.strokeRect(player.x, player.y, player.width, player.height);
    }
    
    // ç¹ªè£½ç¶²æ ¼èƒŒæ™¯
    function drawGrid() {
      ctx.strokeStyle = 'rgba(0, 0, 0, 0.05)';
      ctx.lineWidth = 1;
      
      // å‚ç›´ç·š
      for (let x = 0; x < canvas.width; x += 40) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
      }
      
      // æ°´å¹³ç·š
      for (let y = 0; y < canvas.height; y += 40) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
        ctx.stroke();
      }
    }
    
    // ç¹ªè£½é£›è¡Œè»Œè·¡ç·š
    function drawFlightPath() {
      // å·¦å´èµ·é»æŒ‡ç¤º
      ctx.fillStyle = 'rgba(129, 199, 132, 0.3)';
      ctx.fillRect(0, 0, 30, canvas.height);
      
      // è»Œè·¡æŒ‡ç¤ºç®­é ­
      ctx.fillStyle = 'rgba(129, 199, 132, 0.6)';
      for (let y = 30; y < canvas.height; y += 60) {
        ctx.beginPath();
        ctx.moveTo(20, y);
        ctx.lineTo(40, y - 10);
        ctx.lineTo(40, y + 10);
        ctx.closePath();
        ctx.fill();
      }
      
      // é£›è¡Œæ–¹å‘æ–‡å­—
      ctx.fillStyle = '#81c784';
      ctx.font = '14px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('å¤§é‡‘èµ·é»', 25, 20);
    }

    // é¡¯ç¤ºæç¤º
    function showToast(msg) {
      toast.textContent = msg; 
      toast.style.display = 'block';
      setTimeout(() => { toast.style.display = 'none'; }, 2000);
    }

    // è§£é–ç²¾éˆ
    function unlockSpirit() {
      const spirit = {
        id: 'spirit_game5', 
        name: 'å¤§é‡‘',
        image: 'images/game-spirit5.png', 
        page: 'spirit_game5.html',
        unlockDate: new Date().toISOString(), 
        score: score,
        missed: missed,
        timeLeft: timeLeft
      };
      
      let spirits = [];
      try { 
        spirits = JSON.parse(localStorage.getItem('spirits') || '[]'); 
      } catch(e) { 
        spirits = []; 
      }
      
      if (!spirits.some(s => s.id === spirit.id)) {
        spirits.push(spirit);
        localStorage.setItem('spirits', JSON.stringify(spirits));
        showToast('ğŸ‰ æˆåŠŸè§£é–æŒ‘æˆ°ç²¾éˆï¼šå¤§é‡‘ï¼');
        pillStatus.textContent = 'æŒ‘æˆ°æˆåŠŸï¼';
        pillStatus.className = 'pill ok';
      } else {
        showToast('ä½ å·²ç¶“è§£é–éå¤§é‡‘äº†å–”ï¼');
      }
      
      setTimeout(() => { 
        // å¦‚æœé é¢ä¸å­˜åœ¨ï¼Œå‰‡è·³è½‰åˆ°ä¸»é 
        try {
          window.location.href = spirit.page + '#unlocked';
        } catch(e) {
          window.location.href = 'index.html';
        }
      }, 2000);
    }

    // éŠæˆ²ä¸»å¾ªç’°
    function gameLoop() {
      if (gameOver) {
        renderGame();
        return;
      }
      
      const currentTime = performance.now();
      
      // æ›´æ–°éŠæˆ²ç‹€æ…‹
      if (gameStarted) {
        updatePlayer();
        generatePearl();
        updatePearls();
        renderGame();
      }
      
      // æ›´æ–°æ™‚é–“
      if (currentTime - lastSecondTime >= 1000) {
        timeLeft--; 
        lastSecondTime = currentTime; 
        updateTimeBar();
        pillTimer.textContent = `å‰©é¤˜æ™‚é–“ï¼š${timeLeft} ç§’`;
        
        if (timeLeft <= 0 && !gameOver) {
          gameOver = true;
          pillStatus.textContent = 'æ™‚é–“åˆ°ï¼';
          pillStatus.className = 'pill warn';
          showToast(`æ™‚é–“åˆ°ï¼æœ€çµ‚åˆ†æ•¸: ${score}é¡†`);
          renderGame();
          return;
        }
      }
      
      requestAnimationFrame(gameLoop);
    }

    // åˆå§‹åŒ–éŠæˆ²
    window.addEventListener('DOMContentLoaded', () => {
      initializeGame();
    });
  </script>
</body>
</html>